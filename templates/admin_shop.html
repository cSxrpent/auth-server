<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Manager - Admin</title>
    <style>
        :root{
            --bg:#0a0e1a; --card:#0f1724; --muted:#9aa4b2; --accent:#00d4ff; --danger:#ff4757; --glass: rgba(255,255,255,0.02); --success:#2ed573;
            --radius:16px; --glow:0 0 20px rgba(0,212,255,0.3); --gold:#ffd700;
        }
        *{box-sizing:border-box; margin:0; padding:0;}
        body{
            font-family:'Segoe UI',system-ui,Arial;
            background:linear-gradient(135deg,#071026,#0d1526,#1a1f35);
            color:#eaf1ff;
            min-height:100vh;
            padding:20px;
        }
        .wrap{max-width:1400px; margin:0 auto;}
        header{display:flex; align-items:center; justify-content:space-between; margin-bottom:30px;}
        h1{font-size:2.5rem; background:linear-gradient(90deg,var(--accent),#7b4bff); background-clip:text; -webkit-background-clip:text; color:transparent;}
        .back-btn{background:linear-gradient(90deg,var(--accent),#7b4bff); border:none; padding:10px 16px; border-radius:12px; color:#fff; font-weight:600; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px;}
        .back-btn:hover{transform:scale(1.05); box-shadow:var(--glow)}
        
        .tabs{display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px; flex-wrap:wrap;}
        .tab-btn{background:transparent; border:none; padding:10px 16px; color:var(--muted); cursor:pointer; font-weight:600; position:relative; transition:all 0.3s;}
        .tab-btn:hover{color:#fff}
        .tab-btn.active{color:var(--accent)}
        .tab-btn.active::after{content:''; position:absolute; bottom:-15px; left:0; right:0; height:2px; background:var(--accent);}
        
        .content{display:none;}
        .content.active{display:block;}
        
        .card{background:var(--card); border-radius:var(--radius); padding:20px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05);}
        
        .form-group{margin-bottom:15px;}
        .form-group label{display:block; margin-bottom:8px; color:var(--muted); font-weight:600;}
        input, textarea, select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.02); color:#fff; font-size:14px;}
        input:focus, textarea:focus, select:focus{outline:none; border-color:var(--accent); box-shadow:0 0 10px rgba(0,212,255,0.3)}
        
        .btn{border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s;}
        .btn-primary{background:linear-gradient(90deg,var(--accent),#7b4bff); color:#fff;}
        .btn-primary:hover{transform:scale(1.05); box-shadow:var(--glow)}
        .btn-secondary{background:rgba(255,255,255,0.05); color:var(--muted); border:1px solid rgba(255,255,255,0.1);}
        .btn-secondary:hover{background:rgba(255,255,255,0.1); color:#fff}
        .btn-sm{padding:6px 12px; font-size:13px;}
        .btn-danger{background:rgba(255,71,87,0.2); color:var(--danger); border:1px solid var(--danger);}
        .btn-danger:hover{background:rgba(255,71,87,0.3)}
        
        .settings-grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;}
        .settings-box{background:rgba(255,255,255,0.02); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);}
        
        .list-table{width:100%; border-collapse:collapse;}
        .list-table th{background:rgba(255,255,255,0.05); padding:12px; text-align:left; font-weight:600; color:var(--muted); border-bottom:1px solid rgba(255,255,255,0.1);}
        .list-table td{padding:12px; border-bottom:1px solid rgba(255,255,255,0.05);}
        .list-table tr:hover{background:rgba(255,255,255,0.02)}
        
        .badge{display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600;}
        .badge-active{background:rgba(46,213,115,0.2); color:var(--success);}
        .badge-inactive{background:rgba(255,71,87,0.2); color:var(--danger);}
        
        .status-box{background:rgba(255,255,255,0.02); padding:20px; border-radius:12px; text-align:center;}
        .status-number{font-size:2rem; font-weight:700; color:var(--accent);}
        .status-label{color:var(--muted); font-size:0.9rem; margin-top:5px;}
        
        .success-msg, .error-msg{padding:12px 16px; border-radius:8px; margin-bottom:15px;}
        .success-msg{background:rgba(46,213,115,0.2); color:var(--success); border-left:4px solid var(--success);}
        .error-msg{background:rgba(255,71,87,0.2); color:var(--danger); border-left:4px solid var(--danger);}
        
        .empty{text-align:center; padding:40px; color:var(--muted);}
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <h1>üõçÔ∏è Shop Manager</h1>
            <a href="/admin" class="back-btn">‚Üê Back</a>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab-btn" onclick="switchTab('gift-codes')">üéÅ Gift Codes</button>
            <button class="tab-btn" onclick="switchTab('purchases')">üí∞ Purchases</button>
            <button class="tab-btn" onclick="switchTab('likes')">üëç Likes</button>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="content active">
            <div class="card">
                <h2>Global Promotion Settings</h2>
                <div id="promoMessage"></div>
                
                <div class="settings-grid">
                    <div class="settings-box">
                        <div class="form-group">
                            <label>Promo Status</label>
                            <select id="promoEnabled" onchange="updatePromoStatus()">
                                <option value="false">Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-box">
                        <div class="form-group">
                            <label>Discount Percent (%)</label>
                            <input type="number" id="promoPercent" min="0" max="100" placeholder="e.g., 15" onchange="updatePromoStatus()">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Promo Label (emoji + text)</label>
                    <input type="text" id="promoLabel" placeholder="e.g., üî• 15% OFF SITEWIDE" onchange="updatePromoStatus()">
                </div>
                
                <button class="btn btn-primary" onclick="savePromoSettings()">Save Settings</button>
            </div>
        </div>

        <!-- GIFT CODES TAB -->
        <div id="gift-codes" class="content">
            <div class="card">
                <h2>Create Gift Code</h2>
                <div id="giftCodeMessage"></div>
                
                <div class="form-group">
                    <label>Amount (‚Ç¨)</label>
                    <input type="number" id="giftAmount" min="0.01" step="0.01" placeholder="e.g., 10.00">
                </div>
                
                <div class="form-group">
                    <label>Expiry Date (optional)</label>
                    <input type="date" id="giftExpiry">
                </div>
                
                <button class="btn btn-primary" onclick="createGiftCode()">Generate Code</button>
            </div>

            <div class="card">
                <h2>All Gift Codes</h2>
                <div id="giftCodesList">Loading...</div>
            </div>
        </div>

        <!-- PURCHASES TAB -->
        <div id="purchases" class="content">
            <div class="card">
                <h2>Purchase History</h2>
                <div id="purchasesList">Loading...</div>
            </div>
        </div>

        <!-- LIKES TAB -->
        <div id="likes" class="content">
            <div class="card">
                <h2>Item Likes Statistics</h2>
                <div id="likeStats">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab data
            if (tabName === 'gift-codes') loadGiftCodes();
            if (tabName === 'purchases') loadPurchases();
            if (tabName === 'likes') loadLikeStats();
            if (tabName === 'settings') loadPromoSettings();
        }

        // ============ PROMO SETTINGS ============
        async function loadPromoSettings() {
            try {
                const response = await fetch('/api/shop/settings');
                const data = await response.json();
                
                document.getElementById('promoEnabled').value = data.global_promo_enabled ? 'true' : 'false';
                document.getElementById('promoPercent').value = data.global_promo_percent || 0;
                document.getElementById('promoLabel').value = data.global_promo_label || '';
            } catch (error) {
                console.error('Error loading promo settings:', error);
            }
        }

        async function savePromoSettings() {
            try {
                const data = {
                    global_promo_enabled: document.getElementById('promoEnabled').value === 'true',
                    global_promo_percent: parseInt(document.getElementById('promoPercent').value) || 0,
                    global_promo_label: document.getElementById('promoLabel').value
                };
                
                const response = await fetch('/api/admin/shop/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage('promoMessage', '‚úÖ Settings saved successfully!', 'success');
                } else {
                    showMessage('promoMessage', '‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('promoMessage', '‚ùå Error saving settings', 'error');
            }
        }

        function updatePromoStatus() {
            // Real-time preview
        }

        // ============ GIFT CODES ============
        async function createGiftCode() {
            const amount = document.getElementById('giftAmount').value;
            const expiry = document.getElementById('giftExpiry').value;
            
            if (!amount) {
                showMessage('giftCodeMessage', '‚ùå Please enter an amount', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/gift-codes/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        expires_at: expiry || null
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showMessage('giftCodeMessage', `‚úÖ Code created: <strong>${data.code}</strong>`, 'success');
                    document.getElementById('giftAmount').value = '';
                    document.getElementById('giftExpiry').value = '';
                    loadGiftCodes();
                } else {
                    showMessage('giftCodeMessage', '‚ùå Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('giftCodeMessage', '‚ùå Error creating code', 'error');
            }
        }

        async function loadGiftCodes() {
            try {
                const response = await fetch('/api/admin/gift-codes');
                const data = await response.json();
                
                if (!data.codes || data.codes.length === 0) {
                    document.getElementById('giftCodesList').innerHTML = '<div class="empty">No gift codes yet</div>';
                    return;
                }
                
                let html = '<table class="list-table"><thead><tr><th>Code</th><th>Amount</th><th>Status</th><th>Redeemed By</th><th>Created</th></tr></thead><tbody>';
                data.codes.forEach(code => {
                    html += `<tr>
                        <td><strong>${code.code}</strong></td>
                        <td>‚Ç¨${code.amount.toFixed(2)}</td>
                        <td>${code.is_redeemed ? '<span class="badge badge-inactive">Redeemed</span>' : '<span class="badge badge-active">Available</span>'}</td>
                        <td>${code.redeemed_by || '-'}</td>
                        <td>${code.created_at}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('giftCodesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading gift codes:', error);
                document.getElementById('giftCodesList').innerHTML = '<div class="error-msg">Failed to load gift codes</div>';
            }
        }

        // ============ PURCHASES ============
        async function loadPurchases() {
            try {
                const response = await fetch('/api/admin/purchases');
                const data = await response.json();
                
                if (!data.purchases || data.purchases.length === 0) {
                    document.getElementById('purchasesList').innerHTML = '<div class="empty">No purchases yet</div>';
                    return;
                }
                
                let html = '<table class="list-table"><thead><tr><th>Date</th><th>User</th><th>Items</th><th>Amount</th><th>Coupon</th></tr></thead><tbody>';
                data.purchases.forEach(purchase => {
                    const itemCount = purchase.items ? purchase.items.length : 0;
                    html += `<tr>
                        <td>${purchase.created_at}</td>
                        <td>${purchase.username}</td>
                        <td>${itemCount} item(s)</td>
                        <td>‚Ç¨${purchase.total_amount.toFixed(2)}</td>
                        <td>${purchase.coupon_used || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('purchasesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading purchases:', error);
                document.getElementById('purchasesList').innerHTML = '<div class="error-msg">Failed to load purchases</div>';
            }
        }

        // ============ LIKES ============
        async function loadLikeStats() {
            // For now, show a placeholder
            document.getElementById('likeStats').innerHTML = `
                <div class="card">
                    <p>Like statistics coming soon. Tracked per IP address.</p>
                </div>
            `;
        }

        // ============ UTILITIES ============
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            const className = type === 'success' ? 'success-msg' : 'error-msg';
            el.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPromoSettings();
        });
    </script>
</body>
</html>
