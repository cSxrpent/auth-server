<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    :root{
      --bg:#0a0e1a; --card:#0f1724; --muted:#9aa4b2; --accent:#00d4ff; --danger:#ff4757; --glass: rgba(255,255,255,0.02); --success:#2ed573;
      --radius:16px; --glow:0 0 20px rgba(0,212,255,0.3); --gold:#ffd700;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,Arial;background:linear-gradient(135deg,#071026,#0d1526,#1a1f35);color:#eaf1ff;min-height:100vh;padding:20px;display:flex;justify-content:center;overflow-x:hidden}
    .wrap{width:100%;max-width:1200px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:2rem;background:linear-gradient(90deg,var(--accent),#7b4bff);background-clip:text;-webkit-background-clip:text;color:transparent;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
    .btn-logout{background:linear-gradient(90deg,var(--danger),#ff6b81);border:none;padding:10px 16px;border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all 0.3s;animation:glow 3s infinite}
    .btn-logout:hover{transform:scale(1.05);box-shadow:var(--glow)}
    @keyframes glow{0%,100%{box-shadow:var(--glow)}50%{box-shadow:0 0 30px rgba(255,71,87,0.5)}}
    .nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-btn{background:var(--glass);border:1px solid rgba(255,255,255,0.1);padding:12px 20px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:600;transition:all 0.3s;position:relative;overflow:hidden}
    .nav-btn:hover{background:rgba(255,255,255,0.05);color:#fff}
    .nav-btn.active{background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff;border-color:var(--accent);box-shadow:var(--glow)}
    .nav-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,var(--accent),transparent);transition:left 0.5s}
    .nav-btn:hover::before{left:100%}
    .section{display:none;padding:20px;border-radius:var(--radius);background:var(--card);box-shadow:0 10px 50px rgba(0,0,0,0.7);margin-bottom:20px;animation:slideIn 0.5s ease}
    .section.active{display:block}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    .card{background:linear-gradient(135deg,var(--card),rgba(15,23,36,0.8));border-radius:var(--radius);padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.6);margin-bottom:16px;border:1px solid rgba(255,255,255,0.05)}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:20px}
    .list{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:16px;border-radius:12px;min-height:300px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .small{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center}
    .del{background:linear-gradient(90deg,var(--danger),#ff6b81);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;transition:all 0.3s}
    .del:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(255,71,87,0.4)}
    .extend-btn{background:linear-gradient(90deg,var(--success),#7bed9f);border:none;padding:6px 10px;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s}
    .extend-btn:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(46,213,115,0.4)}
    .pill{background:linear-gradient(90deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));padding:8px 12px;border-radius:20px;font-weight:600;color:var(--muted);border:1px solid rgba(255,255,255,0.1)}
    .fade{animation:fade 0.35s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .toast{position:fixed;right:20px;bottom:20px;background:#06132a;padding:14px 18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);color:#cde7ff;border-left:4px solid var(--accent);animation:slideInRight 0.5s;z-index:9999}
    @keyframes slideInRight{from{right:-300px}to{right:20px}}
    .muted{color:var(--muted)}
    .expired{color:var(--danger)}
    .active{color:var(--success)}
    .extend-section{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:16px;border-radius:12px}
    .duration-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .duration-btns button{padding:10px 14px;cursor:pointer;border-radius:10px;border:none;background:linear-gradient(90deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));color:inherit;font-size:13px;font-weight:600;transition:all 0.3s;border:1px solid rgba(255,255,255,0.1)}
    .duration-btns button:hover{background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff;transform:scale(1.02)}
    input, select{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));color:inherit;font-size:14px;transition:all 0.3s}
    input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    button.primary{background:linear-gradient(90deg,var(--accent),#7b4bff);border:none;padding:12px 18px;border-radius:12px;color:#062033;font-weight:700;cursor:pointer;transition:all 0.3s;animation:glowAccent 3s infinite}
    button.primary:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(0,212,255,0.5)}
    @keyframes glowAccent{0%,100%{box-shadow:0 0 10px rgba(0,212,255,0.3)}50%{box-shadow:0 0 20px rgba(0,212,255,0.6)}}
    .chart-container{margin-top:20px}
    .bar{background:linear-gradient(90deg,var(--accent),#7b4bff);height:30px;border-radius:15px;margin-bottom:8px;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:600;animation:barGrow 1s ease}
    @keyframes barGrow{from{width:0}to{width:var(--width)}}
    .bar span{margin-left:auto}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.nav{justify-content:center}}
    /* Logs & recent styles */
    .log-list{display:flex;flex-direction:column;gap:8px}
    .log-item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.01),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}
    .log-meta{font-weight:700;color:var(--muted);min-width:140px;font-size:12px}
    .badge-info{color:#6bd1ff}
    .badge-warn{color:#ffd26b}
    .badge-error{color:#ff9b9b}

    .recent-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px}
    .recent-avatar{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#1752ff,#7b4bff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .recent-body{flex:1}
    .recent-time{font-size:12px;color:var(--muted)}
    
    /* Keys styles */
    .key-code{font-family:monospace;font-size:1.2rem;font-weight:700;letter-spacing:3px;background:linear-gradient(90deg,var(--gold),#ffed4e);background-clip:text;-webkit-background-clip:text;color:transparent;padding:4px 8px;border-radius:6px;display:inline-block}
    .key-status-unused{color:var(--success);font-weight:600}
    .key-status-used{color:var(--muted);font-style:italic}
    .copy-btn{background:linear-gradient(90deg,var(--accent),#7b4bff);border:none;padding:6px 12px;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s}
    .copy-btn:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    /* Pending testimonials button */
    .btn-pending{background:linear-gradient(90deg,rgba(154,164,178,0.3),rgba(154,164,178,0.2));border:2px solid rgba(154,164,178,0.3);padding:10px 16px;border-radius:12px;color:var(--muted);font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
    .btn-pending.has-pending{background:linear-gradient(90deg,var(--success),#7bed9f);border-color:var(--success);color:#fff;animation:pulse-pending 2s infinite}
    .btn-pending:hover{transform:scale(1.05)}
    @keyframes pulse-pending{0%,100%{box-shadow:0 0 10px rgba(46,213,115,0.3)}50%{box-shadow:0 0 25px rgba(46,213,115,0.6)}}
    #pendingBadge{background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;font-weight:700;font-size:0.9rem}
    .btn-pending.has-pending #pendingBadge{background:#fff;color:var(--success)}
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>
  <div class="wrap">
    <header>
      <div>
        <h1>Admin Panel</h1>
        <div class="small muted">Manage users and subscriptions</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="pendingTestimonialsBtn" class="btn-pending" style="display:none" onclick="switchSection('testimonials')">
          <span id="pendingBadge">0</span> Pending Reviews
        </button>
        <a class="btn-logout" href="/logout">Logout</a>
      </div>
    </header>

    <nav class="nav">
      <button class="nav-btn active" data-section="main">üè† Main</button>
      <button class="nav-btn" data-section="users">üë• Users</button>
      <button class="nav-btn" data-section="keys">üéÅ Keys</button>
      <button class="nav-btn" data-section="connectivity">üåê Connectivity</button>
      <button class="nav-btn" data-section="testimonials">‚≠ê Testimonials</button>
      <button class="nav-btn" data-section="stats">üìä Stats</button>
      <button class="nav-btn" data-section="debug">üîß Debug</button>
    </nav>

    <!-- Main Section -->
    <div id="main" class="section active">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">Summary</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700" id="totalUsers">‚Äî</div>
            <div class="small">Total Users</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--success)" id="activeUsers">‚Äî</div>
            <div class="small">Active</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--danger)" id="expiredUsers">‚Äî</div>
            <div class="small">Expired</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700" id="totalConnections">‚Äî</div>
            <div class="small">Total Connections</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Quick Actions</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="primary" onclick="switchSection('users')">Manage Users</button>
          <button class="primary" onclick="switchSection('keys')">Manage Keys</button>
          <button class="primary" onclick="switchSection('connectivity')">Check Connectivity</button>
          <button class="primary" onclick="switchSection('stats')">View Stats</button>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">Users</div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="pill" id="count">0</div>
                <div class="pill" id="activeCount">‚Äî active</div>
                <div class="pill" id="expiredCount">‚Äî expired</div>
              </div>
            </div>
            <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Search..." style="flex:1" />
              <select id="filter" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));color:inherit">
                <option value="all">All</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
                <option value="recent">Last connected (7d)</option>
              </select>
              <button class="primary" id="exportBtn">Export CSV</button>
            </div>
            <table id="usersTable">
              <thead>
                <tr><th>User</th><th>Last Connected</th><th>Expires</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Add User</div>
            <div class="small muted" style="margin-bottom:16px">Username and duration</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <input id="username" placeholder="Username" />
              <select id="duration">
                <option value="7">1 week</option>
                <option value="30" selected>1 month</option>
                <option value="90">3 months</option>
                <option value="365">1 year</option>
                <option value="0">Unlimited</option>
              </select>
              <button class="primary" id="addBtn">Add</button>
            </div>
          </aside>
        </div>
      </div>
      <div class="card extend-section">
        <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">üìÖ Extend Access</div>
        <input id="extendUsername" placeholder="Username to extend" style="width:100%;margin-bottom:10px" />
        <div class="duration-btns">
          <button onclick="extendUser(7)">+1 week</button>
          <button onclick="extendUser(30)">+1 month</button>
          <button onclick="extendUser(90)">+3 months</button>
          <button onclick="extendUser(365)">+1 year</button>
        </div>
      </div>
    </div>

    <!-- Keys Section -->
    <div id="keys" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">üéÅ Activation Keys</div>
              <div class="pill" id="keysCount">0 keys</div>
            </div>
            <table id="keysTable">
              <thead>
                <tr><th>Key Code</th><th>Duration</th><th>Created</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Generate New Key</div>
            <div class="small muted" style="margin-bottom:16px">Create activation key</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label style="color:var(--muted);font-size:13px">Duration</label>
              <select id="keyDuration">
                <option value="1">1 day</option>
                <option value="7">1 week (7 days)</option>
                <option value="30" selected>1 month (30 days)</option>
                <option value="60">2 months (60 days)</option>
                <option value="90">3 months (90 days)</option>
                <option value="120">4 months (120 days)</option>
                <option value="150">5 months (150 days)</option>
                <option value="270">9 months (270 days)</option>
                <option value="365">1 year (365 days)</option>
                <option value="36500">Permanent (100 years)</option>
              </select>
              <button class="primary" id="generateKeyBtn" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000">‚ú® Generate Key</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <!-- Connectivity Section -->
    <div id="connectivity" class="section">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="font-weight:700;font-size:1.2rem">üîî Ping & Logs</div>
          <div class="small muted">Controls and monitoring</div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
          <div><div class="small muted">URL</div><div class="pill" id="pingUrl">‚Äî</div></div>
          <div><div class="small muted">Status</div><div id="pingStatus" class="pill">‚Äî</div></div>
          <div><div class="small muted">Last</div><div id="pingLast" class="small">‚Äî</div></div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="primary" id="manualPing">Manual Ping</button>
            <button class="primary" id="togglePing">Enable / Disable</button>
            <button class="primary" id="refreshLogs">Refresh</button>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:300px;max-height:300px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px">
            <div style="font-weight:700;margin-bottom:12px">Recent Logs</div>
            <div id="logsList"></div>
          </div>
          <div style="width:350px;min-width:300px;max-height:300px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:700">Recent Connections</div>
              <div class="small muted">Bot access</div>
            </div>
            <div id="recentList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Section -->
    <div id="stats" class="section">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">üìä Usage Statistics</h2>
        <div class="chart-container">
          <div style="font-weight:700;margin-bottom:12px">Connections per user</div>
          <div id="statsChart"></div>
        </div>
      </div>
    </div>

    <!-- Testimonials Section -->
    <div id="testimonials" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">‚≠ê Testimonials</div>
              <div class="pill" id="testimonialsCount">0 reviews</div>
            </div>
            <table id="testimonialsTable">
              <thead>
                <tr><th>User</th><th>Rating</th><th>Comment</th><th>Date</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Add Testimonial</div>
            <div class="small muted" style="margin-bottom:16px">Create a new review</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label style="color:var(--muted);font-size:13px">Username</label>
              <input id="testimonialUsername" placeholder="Player username" />
              
              <label style="color:var(--muted);font-size:13px">Rating</label>
              <select id="testimonialRating">
                <option value="5" selected>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4 stars)</option>
                <option value="3">‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ (3 stars)</option>
                <option value="2">‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ (2 stars)</option>
                <option value="1">‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ (1 star)</option>
              </select>
              
              <label style="color:var(--muted);font-size:13px">Comment</label>
              <textarea id="testimonialComment" placeholder="Review text..." style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));color:inherit;font-size:14px;font-family:inherit;min-height:100px;resize:vertical"></textarea>
              
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--muted);font-size:14px;margin-top:5px">
                <input type="checkbox" id="testimonialAnonymous" style="width:auto;cursor:pointer" />
                <span>Anonymous (hide username)</span>
              </label>
              
              <button class="primary" id="addTestimonialBtn" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000">‚ú® Add Review</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <!-- Debug Section -->
    <div id="debug" class="section">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">üîß Debug Information</h2>
        <p>Configuration status and environment variables:</p>
        <pre id="debugInfo" style="background:rgba(0,0,0,0.3);padding:16px;border-radius:8px;font-size:12px;overflow-x:auto">Loading...</pre>
        <button onclick="loadDebug()" style="margin-top:10px;background:var(--accent);border:none;padding:8px 16px;border-radius:6px;color:#000;font-weight:600;cursor:pointer">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Custom Message Section -->
<div class="section" style="margin-top: 2rem; padding: 1rem; border: 1px solid #414243; border-radius: 8px;">
  <h2 style="margin-bottom: 1rem;">üì¢ Custom Authentication Message</h2>
  <p style="margin-bottom: 1rem; color: #999;">Set a custom message that will be shown to all users when they authenticate:</p>
  <div class="form-group" style="margin-bottom: 1rem;">
    <textarea 
      id="customMessageInput" 
      rows="3" 
      style="width: 100%; max-width: 600px; padding: 0.5rem; background: #181818; color: #fafafa; border: 1px solid #414243; border-radius: 4px; font-family: inherit;"
      placeholder="Enter your custom message here..."></textarea>
  </div>
  <div style="display: flex; gap: 0.5rem;">
    <button onclick="saveCustomMessage()" style="padding: 0.5rem 1rem; cursor: pointer;">üíæ Save Message</button>
    <button onclick="clearCustomMessage()" style="padding: 0.5rem 1rem; cursor: pointer;">üóëÔ∏è Clear Message</button>
  </div>
  <div id="customMessageStatus" style="margin-top: 10px; font-weight: bold;"></div>

  <div id="toast" style="display:none" class="toast">Message</div>


  <script>
    // Particles
    function createParticles(){
      const container = document.getElementById('particles');
      if (!container) return;
      for(let i=0;i<50;i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.position = 'absolute';
        p.style.background = '#00d4ff';
        p.style.borderRadius = '50%';
        p.style.opacity = '0.1';
        p.style.animation = 'float 10s infinite linear';
        p.style.left = Math.random()*100 + '%';
        p.style.width = p.style.height = Math.random()*4 + 2 + 'px';
        p.style.animationDelay = Math.random()*10 + 's';
        container.appendChild(p);
      }
    }
    createParticles();

    const api = {
      list: '/api/users',
      add: '/api/add',
      del: '/api/delete',
      extend: '/api/extend',
      ping: '/api/ping',
      pingStatus: '/api/ping/status',
      logs: '/api/logs',
      recent: '/api/recent',
      export: '/api/export',
      stats: '/api/stats',
      keys: '/api/keys',
      generateKey: '/api/keys/generate',
      deleteKey: '/api/keys/delete'
    };

    function toast(msg, t=3000){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(window._toastTimeout);
      window._toastTimeout = setTimeout(()=> el.style.display='none', t);
    }

    function switchSection(section){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(section).classList.add('active');
      document.querySelector(`[data-section="${section}"]`).classList.add('active');
      
      // Load data when switching to specific sections
      if(section === 'keys') {
        fetchKeys();
      } else if(section === 'testimonials') {
        fetchTestimonials();
      }
    }

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.onclick = () => switchSection(btn.dataset.section);
    });

    async function fetchPingStatus(){
      try{
        const res = await fetch(api.pingStatus, {credentials:'same-origin'});
        if(!res.ok) return;
        const s = await res.json();
        document.getElementById('pingUrl').textContent = s.url || '‚Äî';
        document.getElementById('pingStatus').textContent = s.enabled ? 'Enabled' : 'Disabled';
        document.getElementById('pingLast').textContent = s.last_time ? `${s.last_time} ${s.last_code?('‚Üí '+s.last_code):''}` : '‚Äî';
      }catch(e){ console.warn(e) }
    }

    async function manualPing(){
      try{
        const res = await fetch(api.ping, {method:'POST', credentials:'same-origin'});
        const j = await res.json().catch(()=>({}));
        if(res.ok){ toast(`Ping ok ${j.status}`); } else { toast('Ping failed: '+(j.error||res.status)); }
        await fetchPingStatus();
        await fetchLogs();
        await fetchRecent();
      }catch(e){ toast('Ping error'); }
    }

    async function togglePingHandler(){
      try{
        const sres = await fetch(api.pingStatus, {credentials:'same-origin'});
        const s = await sres.json();
        const enable = !s.enabled;
        const res = await fetch('/api/ping/toggle', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({enabled: enable})
        });
        const j = await res.json().catch(()=>({}));
        if(res.ok){ toast('OK'); } else { toast('Erreur: '+(j.error||res.status)); }
        await fetchPingStatus();
        await fetchLogs();
        await fetchRecent();
      }catch(e){ toast('Erreur'); }
    }

    async function fetchLogs(){
      try{
        const res = await fetch(api.logs, {credentials:'same-origin'});
        if(!res.ok) return;
        const list = await res.json();
        const container = document.getElementById('logsList');
        container.innerHTML = '';
        list.slice(0,20).forEach(item => {
          const el = document.createElement('div');
          el.className = 'log-item';
          if(typeof item === 'object' && item !== null){
            const lvl = (item.level||'info').toLowerCase();
            el.innerHTML = `
              <div class="log-meta">${escapeHtml(item.ts)}</div>
              <div style="flex:1">
                <div class="small muted"> <span class="badge-${lvl}">[${lvl.toUpperCase()}]</span> ${escapeHtml(item.msg)}</div>
              </div>
            `;
          }
          container.appendChild(el);
        });
      }catch(e){ console.warn(e) }
    }

    async function fetchRecent(){
      try{
        const res = await fetch(api.recent, {credentials:'same-origin'});
        if(!res.ok) return;
        const list = await res.json();
        const container = document.getElementById('recentList');
        container.innerHTML = '';
        list.slice(0,20).forEach(r => {
          const div = document.createElement('div');
          div.className = 'recent-item';
          const avatar = document.createElement('div');
          avatar.className = 'recent-avatar';
          avatar.textContent = (r.username||'?').charAt(0).toUpperCase();
          const body = document.createElement('div');
          body.className = 'recent-body';
          body.innerHTML = `<div><strong>${escapeHtml(r.username||'‚Äî')}</strong> <span class="small muted">@${escapeHtml(r.ip||'‚Äî')}</span></div><div class="recent-time">${escapeHtml(r.ts)} ‚Ä¢ <span class="small muted">${escapeHtml(r.status)}</span></div>`;
          div.appendChild(avatar);
          div.appendChild(body);
          container.appendChild(div);
        });
      }catch(e){ console.warn(e) }
    }

    async function fetchStats(){
      try{
        const res = await fetch(api.stats, {credentials:'same-origin'});
        if(!res.ok) return;
        const stats = await res.json();
        renderStats(stats);
      }catch(e){ console.warn(e) }
    }

    function renderStats(stats){
      const container = document.getElementById('statsChart');
      container.innerHTML = '';
      if(stats.length === 0){
        container.innerHTML = '<div class="small muted">No data</div>';
        return;
      }
      const max = Math.max(...stats.map(s => s[1]));
      stats.forEach(([user, count]) => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.setProperty('--width', `${(count / max) * 100}%`);
        bar.innerHTML = `<span>${escapeHtml(user)}</span><span>${count}</span>`;
        container.appendChild(bar);
      });
    }

    async function loadDebug(){
      try{
        const res = await fetch('/debug', {credentials:'same-origin'});
        if(!res.ok) return;
        const info = await res.json();
        document.getElementById('debugInfo').textContent = JSON.stringify(info, null, 2);
      }catch(e){ 
        document.getElementById('debugInfo').textContent = 'Error loading debug info: ' + e.message;
      }
    }

    document.getElementById('exportBtn').onclick = ()=> { window.location = api.export };
    document.getElementById('manualPing').onclick = manualPing;
    document.getElementById('togglePing').onclick = togglePingHandler;
    document.getElementById('refreshLogs').onclick = async () => { await fetchLogs(); await fetchRecent(); };

    document.getElementById('search').oninput = function(){
      const q = this.value.toLowerCase().trim();
      document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
        const uname = tr.querySelector('td strong')?.textContent?.toLowerCase() || '';
        tr.style.display = uname.includes(q) ? '' : 'none';
      });
    }

    document.getElementById('filter').onchange = fetchUsers;

    async function fetchUsers(){
      const res = await fetch(api.list, {credentials:'same-origin'});
      if(!res.ok){ toast('Erreur: '+res.status); return; }
      const users = await res.json();
      renderUsers(users);
      updateMainStats(users);
    }

    function updateMainStats(users){
      const total = users.length;
      const active = users.filter(u => new Date(u.expires) > new Date()).length;
      const expired = total - active;
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('activeUsers').textContent = active;
      document.getElementById('expiredUsers').textContent = expired;
      // Total connections from stats
      fetch(api.stats, {credentials:'same-origin'}).then(res => res.json()).then(stats => {
        const totalConn = stats.reduce((sum, [,count]) => sum + count, 0);
        document.getElementById('totalConnections').textContent = totalConn;
      }).catch(() => document.getElementById('totalConnections').textContent = '‚Äî');
    }

    function renderUsers(users){
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      let count = 0;
      let active = 0;
      let expired = 0;
      
      const filter = document.getElementById('filter').value;
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      users.forEach(u=>{
        const expires = u.expires || '‚Äî';
        const expiryDate = new Date(expires);
        const isExpired = expiryDate < now;
        const lastConn = u.last_connected ? new Date(u.last_connected.substring(0,10)) : null;
        const isRecent = lastConn && lastConn > sevenDaysAgo;
        
        // Apply filter
        let show = true;
        if(filter === 'active' && isExpired) show = false;
        else if(filter === 'expired' && !isExpired) show = false;
        else if(filter === 'recent' && !isRecent) show = false;
        
        if(!show) return;
        
        count++;
        const tr = document.createElement('tr');
        
        const expiryClass = isExpired ? 'expired' : 'active';
        if(isExpired) expired++; else active++;
        
        const lastConnDisplay = u.last_connected ? u.last_connected.substring(0,10) : 'Never';
        
        tr.innerHTML = `
          <td><strong>${escapeHtml(u.username)}</strong></td>
          <td class="small muted">${lastConnDisplay}</td>
          <td class="${expiryClass}">${expires}</td>
          <td class="actions">
            <button class="extend-btn" onclick="quickExtend('${escapeHtml(u.username)}', 7)">+7j</button>
            <button class="extend-btn" onclick="quickExtend('${escapeHtml(u.username)}', 30)">+1m</button>
            <button class="del" data-username="${u.username}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('count').textContent = count;
      document.getElementById('activeCount').textContent = active + ' active';
      document.getElementById('expiredCount').textContent = expired + ' expired';
      
      // attach delete handlers
      document.querySelectorAll('.del').forEach(btn=>{
        btn.onclick = async ()=> {
          const username = btn.dataset.username;
          if(!confirm(`Delete ${username}?`)) return;
          const res = await fetch(api.del, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username}),
            credentials:'same-origin'
          });
          if(res.ok){
            toast('Deleted');
            btn.closest('tr').style.transition='opacity .4s';
            btn.closest('tr').style.opacity='0';
            setTimeout(fetchUsers, 420);
          } else {
            const j = await res.json().catch(()=>({}));
            toast('Error: ' + (j.error || res.status));
          }
        }
      })
    }

    async function extendUser(days){
      const username = document.getElementById('extendUsername').value.trim();
      if(!username){ toast('Username required'); return; }
      
      const res = await fetch(api.extend, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, days}),
        credentials:'same-origin'
      });
      
      if(res.ok){
        const result = await res.json();
        toast(`‚úÖ +${days}j for ${username}\nNew date: ${result.newExpires}`);
        document.getElementById('extendUsername').value = '';
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('‚ùå ' + (j.error || 'Error'));
      }
    }

    async function quickExtend(username, days){
      if(!confirm(`Extend ${username} by ${days} days?`)) return;
      
      const res = await fetch(api.extend, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, days}),
        credentials:'same-origin'
      });
      
      if(res.ok){
        const result = await res.json();
        toast(`‚úÖ Extended until ${result.newExpires}`);
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('‚ùå ' + (j.error || 'Error'));
      }
    }

    // Keys functions
    async function fetchKeys(){
      try{
        const res = await fetch(api.keys, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading keys'); return; }
        const keys = await res.json();
        renderKeys(keys);
      }catch(e){ 
        console.error(e);
        toast('Error loading keys');
      }
    }

    function renderKeys(keys){
      const tbody = document.querySelector('#keysTable tbody');
      tbody.innerHTML = '';
      document.getElementById('keysCount').textContent = keys.length + ' keys';
      
      if(keys.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No keys yet</td></tr>';
        return;
      }
      
      keys.forEach(k => {
        const tr = document.createElement('tr');
        const statusClass = k.used ? 'key-status-used' : 'key-status-unused';
        const statusText = k.used ? `Used by ${k.used_by || '?'} on ${k.used_at || '?'}` : 'Unused';
        
        tr.innerHTML = `
          <td><span class="key-code">${escapeHtml(k.code)}</span></td>
          <td>${k.duration} days</td>
          <td class="small muted">${k.created ? k.created.substring(0,10) : '‚Äî'}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="actions">
            <button class="copy-btn" onclick="copyKey('${escapeHtml(k.code)}')">üìã Copy</button>
            ${!k.used ? `<button class="del" onclick="deleteKey('${escapeHtml(k.code)}')">Delete</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function generateKey(){
      const duration = parseInt(document.getElementById('keyDuration').value);
      
      if(!duration || duration <= 0){
        toast('Invalid duration');
        return;
      }
      
      try{
        const res = await fetch(api.generateKey, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({duration}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          const result = await res.json();
          toast(`‚ú® Key generated: ${result.key.code}`);
          await fetchKeys();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('‚ùå ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error generating key');
      }
    }

    async function deleteKey(code){
      if(!confirm(`Delete key ${code}?`)) return;
      
      try{
        const res = await fetch(api.deleteKey, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('Key deleted');
          await fetchKeys();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('‚ùå ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error deleting key');
      }
    }

    function copyKey(code){
      navigator.clipboard.writeText(code).then(() => {
        toast(`‚úÖ Copied: ${code}`);
      }).catch(() => {
        toast('‚ùå Failed to copy');
      });
    }

    document.getElementById('generateKeyBtn').onclick = generateKey;

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.getElementById('addBtn').onclick = async ()=>{
      const username = document.getElementById('username').value.trim();
      const duration = document.getElementById('duration').value;
      if(!username){ toast('Username required'); return; }
      const body = { username, duration: parseInt(duration) || 0 };
      const res = await fetch(api.add, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(body)
      });
      if(res.ok){
        toast('User added');
        document.getElementById('username').value = '';
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('Error: ' + (j.error || res.status));
      }
    }

    // Testimonials management
    const testimonialsApi = {
      list: '/api/testimonials',
      add: '/api/testimonials/add',
      delete: '/api/testimonials/delete'
    };
    
    async function fetchTestimonials(){
      try{
        const res = await fetch(testimonialsApi.list, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading testimonials'); return; }
        const testimonials = await res.json();
        renderTestimonials(testimonials);
        updatePendingBadge(testimonials);
      }catch(e){
        console.error(e);
        toast('Error loading testimonials');
      }
    }
    
    function renderTestimonials(testimonials){
      const tbody = document.querySelector('#testimonialsTable tbody');
      tbody.innerHTML = '';
      
      // S√©parer pending et approved
      const pending = testimonials.filter(t => !t.approved);
      const approved = testimonials.filter(t => t.approved);
      
      document.getElementById('testimonialsCount').textContent = `${testimonials.length} reviews (${pending.length} pending)`;
      
      if(testimonials.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No testimonials yet</td></tr>';
        return;
      }
      
      // Show pending first
      [...pending, ...approved].forEach(t => {
        const tr = document.createElement('tr');
        const stars = '‚≠ê'.repeat(t.rating);
        const displayName = t.anonymous ? 'üï∂Ô∏è Anonymous' : t.username;
        const truncatedComment = t.comment.length > 50 ? t.comment.substring(0, 50) + '...' : t.comment;
        const statusBadge = t.approved ? 
          '<span style="color:var(--success);font-weight:600">‚úì Approved</span>' : 
          '<span style="color:#ff9b9b;font-weight:600">‚è≥ Pending</span>';
        
        tr.innerHTML = `
          <td><strong>${escapeHtml(displayName)}</strong><br><small>${statusBadge}</small></td>
          <td>${stars}</td>
          <td class="small muted" title="${escapeHtml(t.comment)}">${escapeHtml(truncatedComment)}</td>
          <td class="small muted">${t.date}</td>
          <td class="actions">
            ${!t.approved ? `<button class="extend-btn" onclick="approveTestimonial('${escapeHtml(t.id)}')">‚úì Approve</button>` : ''}
            <button class="del" onclick="deleteTestimonial('${escapeHtml(t.id)}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updatePendingBadge(testimonials){
      const pending = testimonials.filter(t => !t.approved);
      const btn = document.getElementById('pendingTestimonialsBtn');
      const badge = document.getElementById('pendingBadge');
      
      if(pending.length > 0){
        btn.style.display = 'flex';
        btn.classList.add('has-pending');
        badge.textContent = pending.length;
      } else {
        btn.style.display = 'flex';
        btn.classList.remove('has-pending');
        badge.textContent = '0';
      }
    }
    
    async function approveTestimonial(id){
      try{
        const res = await fetch('/api/testimonials/approve', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('‚úÖ Testimonial approved');
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('‚ùå ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error approving testimonial');
      }
    }
    
    document.getElementById('addTestimonialBtn').onclick = async () => {
      const username = document.getElementById('testimonialUsername').value.trim();
      const rating = parseInt(document.getElementById('testimonialRating').value);
      const comment = document.getElementById('testimonialComment').value.trim();
      const anonymous = document.getElementById('testimonialAnonymous').checked;
      
      if(!username){ toast('Username required'); return; }
      if(!comment){ toast('Comment required'); return; }
      
      try{
        const res = await fetch(testimonialsApi.add, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({username, rating, comment, anonymous}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('‚úÖ Testimonial added');
          document.getElementById('testimonialUsername').value = '';
          document.getElementById('testimonialComment').value = '';
          document.getElementById('testimonialAnonymous').checked = false;
          document.getElementById('testimonialRating').value = '5';
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('‚ùå ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error adding testimonial');
      }
    };
    
    async function deleteTestimonial(id){
      if(!confirm('Delete this testimonial?')) return;
      
      try{
        const res = await fetch(testimonialsApi.delete, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('Testimonial deleted');
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('‚ùå ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error deleting testimonial');
      }
    }

    // Initial loads
    fetchUsers();
    fetchPingStatus();
    fetchLogs();
    fetchRecent();
    fetchStats();
    loadDebug();
    fetchTestimonials();
  </script>
</body>
</html>