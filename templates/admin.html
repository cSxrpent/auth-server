<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <style>
    :root{
      --bg:#0a0e1a; --card:#0f1724; --muted:#9aa4b2; --accent:#00d4ff; --danger:#ff4757; --glass: rgba(255,255,255,0.02); --success:#2ed573;
      --radius:16px; --glow:0 0 20px rgba(0,212,255,0.3); --gold:#ffd700;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,Arial;background:linear-gradient(135deg,#071026,#0d1526,#1a1f35);color:#eaf1ff;min-height:100vh;padding:20px;display:flex;justify-content:center;overflow-x:hidden}
    .wrap{width:100%;max-width:1200px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:2rem;background:linear-gradient(90deg,var(--accent),#7b4bff);background-clip:text;-webkit-background-clip:text;color:transparent;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
    .btn-logout{background:linear-gradient(90deg,var(--danger),#ff6b81);border:none;padding:10px 16px;border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all 0.3s;animation:glow 3s infinite}
    .btn-logout:hover{transform:scale(1.05);box-shadow:var(--glow)}
    @keyframes glow{0%,100%{box-shadow:var(--glow)}50%{box-shadow:0 0 30px rgba(255,71,87,0.5)}}
    .nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-btn{background:var(--glass);border:1px solid rgba(255,255,255,0.1);padding:12px 20px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:600;transition:all 0.3s;position:relative;overflow:hidden}
    .nav-btn:hover{background:rgba(255,255,255,0.05);color:#fff}
    .nav-btn.active{background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff;border-color:var(--accent);box-shadow:var(--glow)}
    .nav-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,var(--accent),transparent);transition:left 0.5s}
    .nav-btn:hover::before{left:100%}
    .section{display:none;padding:20px;border-radius:var(--radius);background:var(--card);box-shadow:0 10px 50px rgba(0,0,0,0.7);margin-bottom:20px;animation:slideIn 0.5s ease}
    .section.active{display:block}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    .card{background:linear-gradient(135deg,var(--card),rgba(15,23,36,0.8));border-radius:var(--radius);padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.6);margin-bottom:16px;border:1px solid rgba(255,255,255,0.05)}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:20px}
    .list{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:16px;border-radius:12px;min-height:300px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .small{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center}
    .del{background:linear-gradient(90deg,var(--danger),#ff6b81);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;transition:all 0.3s}
    .del:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(255,71,87,0.4)}
    .extend-btn{background:linear-gradient(90deg,var(--success),#7bed9f);border:none;padding:6px 10px;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s}
    .extend-btn:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(46,213,115,0.4)}
    .pill{background:linear-gradient(90deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));padding:8px 12px;border-radius:20px;font-weight:600;color:var(--muted);border:1px solid rgba(255,255,255,0.1)}
    .fade{animation:fade 0.35s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .toast{position:fixed;right:20px;bottom:20px;background:#06132a;padding:14px 18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);color:#cde7ff;border-left:4px solid var(--accent);animation:slideInRight 0.5s;z-index:9999}
    @keyframes slideInRight{from{right:-300px}to{right:20px}}
    .muted{color:var(--muted)}
    .expired{color:var(--danger)}
    .active{color:var(--success)}
    .extend-section{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:16px;border-radius:12px}
    .duration-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .duration-btns button{padding:10px 14px;cursor:pointer;border-radius:10px;border:none;background:linear-gradient(90deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));color:inherit;font-size:13px;font-weight:600;transition:all 0.3s;border:1px solid rgba(255,255,255,0.1)}
    .duration-btns button:hover{background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff;transform:scale(1.02)}
    input, select{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));color:inherit;font-size:14px;transition:all 0.3s}
    input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    textarea{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));color:inherit;font-size:14px;font-family:inherit;min-height:100px;resize:vertical;width:100%;transition:all 0.3s}
    textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    button.primary{background:linear-gradient(90deg,var(--accent),#7b4bff);border:none;padding:12px 18px;border-radius:12px;color:#062033;font-weight:700;cursor:pointer;transition:all 0.3s;animation:glowAccent 3s infinite}
    button.primary:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(0,212,255,0.5)}
    @keyframes glowAccent{0%,100%{box-shadow:0 0 10px rgba(0,212,255,0.3)}50%{box-shadow:0 0 20px rgba(0,212,255,0.6)}}
    .chart-container{margin-top:20px}
    .bar{background:linear-gradient(90deg,var(--accent),#7b4bff);height:30px;border-radius:15px;margin-bottom:8px;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:600;animation:barGrow 1s ease}
    @keyframes barGrow{from{width:0}to{width:var(--width)}}
    .bar span{margin-left:auto}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.nav{justify-content:center}}
    .log-list{display:flex;flex-direction:column;gap:8px}
    .log-item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.01),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}
    .log-meta{font-weight:700;color:var(--muted);min-width:140px;font-size:12px}
    .badge-info{color:#6bd1ff}
    .badge-warn{color:#ffd26b}
    .badge-error{color:#ff9b9b}
    .recent-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px}
    .recent-avatar{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#1752ff,#7b4bff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .recent-body{flex:1}
    .recent-time{font-size:12px;color:var(--muted)}
    .key-code{font-family:monospace;font-size:1.2rem;font-weight:700;letter-spacing:3px;background:linear-gradient(90deg,var(--gold),#ffed4e);background-clip:text;-webkit-background-clip:text;color:transparent;padding:4px 8px;border-radius:6px;display:inline-block}
    .key-status-unused{color:var(--success);font-weight:600}
    .key-status-used{color:var(--muted);font-style:italic}
    .copy-btn{background:linear-gradient(90deg,var(--accent),#7b4bff);border:none;padding:6px 12px;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s}
    .copy-btn:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    .btn-pending{background:linear-gradient(90deg,rgba(154,164,178,0.3),rgba(154,164,178,0.2));border:2px solid rgba(154,164,178,0.3);padding:10px 16px;border-radius:12px;color:var(--muted);font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
    .btn-pending.has-pending{background:linear-gradient(90deg,var(--success),#7bed9f);border-color:var(--success);color:#fff;animation:pulse-pending 2s infinite}
    .btn-pending:hover{transform:scale(1.05)}
    @keyframes pulse-pending{0%,100%{box-shadow:0 0 10px rgba(46,213,115,0.3)}50%{box-shadow:0 0 25px rgba(46,213,115,0.6)}}
    #pendingBadge{background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;font-weight:700;font-size:0.9rem}
    .btn-pending.has-pending #pendingBadge{background:#fff;color:var(--success)}
    
    /* Shop-specific styles */
    .badge{padding:5px 12px;border-radius:20px;font-size:0.85rem;font-weight:600;display:inline-block}
    .badge-active{background:rgba(46,213,115,0.2);color:var(--success);border:1px solid var(--success)}
    .badge-inactive{background:rgba(255,71,87,0.2);color:var(--danger);border:1px solid var(--danger)}
    .btn-sm{padding:6px 15px;font-size:0.9rem}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#e84118);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}
    .btn-success{background:linear-gradient(135deg,var(--success),#20bf55);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .gems-low{color:var(--danger);font-weight:bold}
    .gems-medium{color:#ed8936;font-weight:bold}
    .gems-high{color:var(--success);font-weight:bold}
    .status-active{color:var(--success);font-weight:bold}
    .status-inactive{color:var(--danger);font-weight:bold}
    
    /* Purchase Status Styles */
    .status-badge{display:inline-block;padding:6px 12px;border-radius:16px;font-size:0.85rem;font-weight:600}
    .status-awaiting-contact{background:rgba(154,164,178,0.2);color:#9aa4b2;border:1px solid rgba(154,164,178,0.3)}
    .status-awaiting-transaction{background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid rgba(255,193,7,0.3)}
    .status-completed{background:rgba(46,213,115,0.2);color:var(--success);border:1px solid var(--success)}
    .btn-status-action{background:linear-gradient(90deg,var(--accent),#7b4bff);border:none;padding:6px 12px;border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all 0.3s}
    .btn-status-action:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(0,212,255,0.3)}
    .btn-status-action:disabled{opacity:0.5;cursor:not-allowed}
    .purchase-actions{display:flex;gap:6px;flex-wrap:wrap}
    .form-group label{display:block;margin-bottom:8px;color:var(--gold);font-weight:600;font-size:0.9rem}
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>
  <div class="wrap">
    <header>
      <div>
        <h1>Admin Panel</h1>
        <div class="small muted">Complete management dashboard</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="pendingRosesGemsBtn" class="btn-pending" style="display:none" onclick="switchSection('roses-gems')">
          <span id="rosesGemsBadge">0</span> Roses & Gems Pending
        </button>
        <button id="pendingTestimonialsBtn" class="btn-pending" style="display:none" onclick="switchSection('testimonials')">
          <span id="pendingBadge">0</span> Pending Reviews
        </button>
        <a class="btn-logout" href="/logout">Logout</a>
      </div>
    </header>

    <nav class="nav">
      <button class="nav-btn active" data-section="main">ğŸ  Main</button>
      <button class="nav-btn" data-section="users">ğŸ‘¥ Users</button>
      <button class="nav-btn" data-section="keys">ğŸ Keys</button>
      <button class="nav-btn" data-section="shop-management">ğŸ›’ Shop</button>
      <button class="nav-btn" data-section="send-gifts">ğŸ Send Gifts</button>
      <button class="nav-btn" data-section="coupons">ğŸ« Coupons</button>
      <button class="nav-btn" data-section="gem-accounts">ğŸ’ Gem Accounts</button>
      <button class="nav-btn" data-section="roses-gems">ğŸŒ¹ Roses & Gems</button>
      <button class="nav-btn" data-section="paypal-purchases">ğŸ’³ PayPal Purchases</button>
      <button class="nav-btn" data-section="connectivity">ğŸŒ Connectivity</button>
      <button class="nav-btn" data-section="testimonials">â­ Testimonials</button>
      <button class="nav-btn" data-section="stats">ğŸ“Š Stats</button>
      <button class="nav-btn" data-section="debug">ğŸ”§ Debug</button>
    </nav>

    
    <div id="main" class="section active">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">Dashboard Summary</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700" id="totalUsers">â€”</div>
            <div class="small">Total Users</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--success)" id="activeUsers">â€”</div>
            <div class="small">Active</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--danger)" id="expiredUsers">â€”</div>
            <div class="small">Expired</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700" id="totalConnections">â€”</div>
            <div class="small">Total Connections</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--gold)" id="totalGemAccounts">â€”</div>
            <div class="small">Gem Accounts</div>
          </div>
          <div class="pill" style="text-align:center;padding:20px">
            <div style="font-size:2rem;font-weight:700;color:var(--accent)" id="totalCoupons">â€”</div>
            <div class="small">Active Coupons</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Quick Actions</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="primary" onclick="switchSection('users')">Manage Users</button>
          <button class="primary" onclick="switchSection('shop-management')">Manage Shop</button>
          <button class="primary" onclick="switchSection('coupons')">Manage Coupons</button>
          <button class="primary" onclick="switchSection('gem-accounts')">Gem Accounts</button>
        </div>
      </div>
    </div>

    
    <div id="users" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">Users</div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="pill" id="count">0</div>
                <div class="pill" id="activeCount">â€” active</div>
                <div class="pill" id="expiredCount">â€” expired</div>
              </div>
            </div>
            <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Search..." style="flex:1" />
              <select id="filter" style="padding:10px 12px">
                <option value="all">All</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
                <option value="recent">Last connected (7d)</option>
              </select>
              <button class="primary" id="exportBtn">Export CSV</button>
            </div>
            <table id="usersTable">
              <thead>
                <tr><th>User</th><th>Last Connected</th><th>Expires</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Add User</div>
            <div class="small muted" style="margin-bottom:16px">Username and duration</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <input id="username" placeholder="Username" />
              <select id="duration">
                <option value="7">1 week</option>
                <option value="30" selected>1 month</option>
                <option value="90">3 months</option>
                <option value="365">1 year</option>
                <option value="0">Unlimited</option>
              </select>
              <button class="primary" id="addBtn">Add</button>
            </div>
          </aside>
        </div>
      </div>
      <div class="card extend-section">
        <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">ğŸ“… Extend Access</div>
        <input id="extendUsername" placeholder="Username to extend" style="width:100%;margin-bottom:10px" />
        <div class="duration-btns">
          <button onclick="extendUser(7)">+1 week</button>
          <button onclick="extendUser(30)">+1 month</button>
          <button onclick="extendUser(90)">+3 months</button>
          <button onclick="extendUser(365)">+1 year</button>
        </div>
      </div>
    </div>

    
    <div id="keys" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">ğŸ Activation Keys</div>
              <div class="pill" id="keysCount">0 keys</div>
            </div>
            <table id="keysTable">
              <thead>
                <tr><th>Key Code</th><th>Duration</th><th>Created</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Generate New Key</div>
            <div class="small muted" style="margin-bottom:16px">Create activation key</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label style="color:var(--muted);font-size:13px">Duration</label>
              <select id="keyDuration">
                <option value="1">1 day</option>
                <option value="7">1 week (7 days)</option>
                <option value="30" selected>1 month (30 days)</option>
                <option value="60">2 months (60 days)</option>
                <option value="90">3 months (90 days)</option>
                <option value="120">4 months (120 days)</option>
                <option value="150">5 months (150 days)</option>
                <option value="270">9 months (270 days)</option>
                <option value="365">1 year (365 days)</option>
                <option value="36500">Permanent (100 years)</option>
              </select>
              <button class="primary" id="generateKeyBtn" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000">âœ¨ Generate Key</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    
    <div id="shop-management" class="section">
      
      <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:15px;flex-wrap:wrap">
        <button class="tab-btn" style="background:transparent;border:none;padding:10px 16px;color:var(--accent);cursor:pointer;font-weight:600;position:relative" onclick="switchShopTab('settings')">âš™ï¸ Settings</button>
        <button class="tab-btn" style="background:transparent;border:none;padding:10px 16px;color:var(--muted);cursor:pointer;font-weight:600;position:relative" onclick="switchShopTab('gift-codes')">ğŸ Gift Codes</button>
        <button class="tab-btn" style="background:transparent;border:none;padding:10px 16px;color:var(--muted);cursor:pointer;font-weight:600;position:relative" onclick="switchShopTab('purchases')">ğŸ’° Purchases</button>
        <button class="tab-btn" style="background:transparent;border:none;padding:10px 16px;color:var(--muted);cursor:pointer;font-weight:600;position:relative" onclick="switchShopTab('likes')">ğŸ‘ Likes</button>
      </div>

      
      <div id="shop-settings" class="content" style="display:block">
        <div class="card">
          <h2 style="margin-top:0;color:var(--accent)">Global Promotion Settings</h2>
          <div id="promoMessage"></div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div style="background:rgba(255,255,255,0.02);padding:15px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)">
              <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px;color:var(--muted);font-weight:600">Promo Status</label>
                <select id="promoEnabled" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff;font-size:14px" onchange="updatePromoStatus()">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
            </div>
            
            <div style="background:rgba(255,255,255,0.02);padding:15px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)">
              <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px;color:var(--muted);font-weight:600">Discount Percent (%)</label>
                <input type="number" id="promoPercent" min="0" max="100" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff;font-size:14px" placeholder="e.g., 15" onchange="updatePromoStatus()">
              </div>
            </div>
          </div>
          
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-weight:600">Promo Label (emoji + text)</label>
            <input type="text" id="promoLabel" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff;font-size:14px" placeholder="e.g., ğŸ”¥ 15% OFF SITEWIDE" onchange="updatePromoStatus()">
          </div>
          
          <button class="btn-primary" style="border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff" onclick="savePromoSettings()">Save Settings</button>
        </div>
      </div>

      
      <div id="shop-gift-codes" class="content" style="display:none">
        <div class="card">
          <h2 style="margin-top:0;color:var(--accent)">Create Gift Code</h2>
          <div id="giftCodeMessage"></div>
          
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-weight:600">Amount (â‚¬)</label>
            <input type="number" id="giftAmount" min="0.01" step="0.01" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff;font-size:14px" placeholder="e.g., 10.00">
          </div>
          
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-weight:600">Expiry Date (optional)</label>
            <input type="date" id="giftExpiry" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff;font-size:14px">
          </div>
          
          <button class="btn-primary" style="border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--accent),#7b4bff);color:#fff" onclick="createGiftCode()">Generate Code</button>
        </div>

        <div class="card">
          <h2 style="margin-top:0;color:var(--accent)">All Gift Codes</h2>
          <div id="giftCodesList">Loading...</div>
        </div>
      </div>

      
      <div id="shop-purchases" class="content" style="display:none">
        <div class="card">
          <h2 style="margin-top:0;color:var(--accent)">ğŸŒ¹ Roses & Gems Purchases</h2>
          <p style="color:var(--muted);margin:10px 0">Manage all customer purchases for Roses and Gems</p>
          <div class="list">
            <table id="purchasesTable">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Platform</th>
                  <th>Item</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="purchasesTableBody">
                <tr><td colspan="8" style="text-align:center;color:var(--muted)">Loading purchases...</td></tr>
              </tbody>
            </table>
          </div>
          <div id="purchasesEmpty" style="display:none;text-align:center;padding:40px;color:var(--muted)">
            <div style="font-size:2rem;margin-bottom:12px">ğŸ“­</div>
            <div>No purchases yet</div>
          </div>
        </div>
      </div>

      
      <div id="shop-likes" class="content" style="display:none">
        <div class="card">
          <h2 style="margin-top:0;color:var(--accent)">Item Likes Statistics</h2>
          <div id="likeStats">Loading...</div>
        </div>
      </div>
    </div>

    
    <div id="coupons" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">ğŸ« Coupons</div>
              <div class="pill" id="couponsCount">0 coupons</div>
            </div>
            <table id="couponsTable">
              <thead>
                <tr><th>Code</th><th>Discount</th><th>Uses</th><th>Status</th><th>Expires</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Create Coupon</div>
            <div class="small muted" style="margin-bottom:16px">New discount code</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label>Code</label>
              <input id="couponCode" placeholder="SAVE20" maxlength="20" style="text-transform:uppercase" />
              <label>Discount %</label>
              <input type="number" id="couponDiscount" placeholder="20" min="1" max="100" />
              <label>Max Uses (Optional)</label>
              <input type="number" id="couponMaxUses" placeholder="Unlimited" min="1" />
              <label>Expires (Optional)</label>
              <input type="datetime-local" id="couponExpires" />
              <button class="primary" id="createCouponBtn" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000">âœ¨ Create</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    
    <div id="gem-accounts" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">ğŸ’ Gem Accounts</div>
              <div style="display:flex;gap:8px">
                <div class="pill" id="gemAccountsCount">0 accounts</div>
                <div class="pill" id="gemAccountsActive">â€” active</div>
              </div>
            </div>
            <table id="gemAccountsTable">
              <thead>
                <tr><th>#</th><th>Email</th><th>Nickname</th><th>Gems</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Add Account</div>
            <div class="small muted" style="margin-bottom:16px">New gem account</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label>Account #</label>
              <input type="number" id="gemAccountNumber" placeholder="1, 2, 3..." />
              <label>Email</label>
              <input type="email" id="gemAccountEmail" placeholder="bugs bot1@example.com" />
              <label>Password</label>
              <input type="password" id="gemAccountPassword" placeholder="Password" />
              <button class="primary" id="addGemAccountBtn">Add Account</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    
    <div id="send-gifts" class="section">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">ğŸ Send Free Gifts</h2>
        <p class="small muted" style="margin-bottom:20px">Send shop items to users without payment</p>
        
        <div class="grid">
          <div style="background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:20px;border-radius:12px">
            <h3 style="margin-top:0">Gift Details</h3>
            
            <div style="display:flex;flex-direction:column;gap:15px">
              <div class="form-group">
                <label>Recipient Username</label>
                <input id="giftUsername" placeholder="Wolvesville username" />
              </div>
              
              <div class="form-group">
                <label>Gift Type</label>
                <select id="giftType" onchange="updateGiftForm()">
                  <option value="">-- Select Type --</option>
                  <option value="gems">ğŸ’ Gems Package</option>
                  <option value="bundle">ğŸ“¦ Bundle</option>
                  <option value="calendar">ğŸ“… Calendar</option>
                  <option value="premium">ğŸ‘‘ Premium Item</option>
                  <option value="custom">âœ¨ Custom Item</option>
                </select>
              </div>
              
              
              <div id="giftFormContainer"></div>
              
              <div class="form-group">
                <label>Gift Message (Optional)</label>
                <textarea id="giftMessage" rows="3" placeholder="Add a personal message..."></textarea>
              </div>
              
              <button class="primary" onclick="sendGift()" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000;padding:15px">
                ğŸ Send Gift (Free)
              </button>
            </div>
          </div>
          
          <aside style="padding:20px;border-radius:12px;background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,215,0,0.05));border:1px solid rgba(255,215,0,0.3)">
            <h3 style="color:var(--gold);margin-top:0">ğŸ“‹ Quick Select</h3>
            <div class="small muted" style="margin-bottom:15px">Popular gift packages</div>
            
            <div style="display:flex;flex-direction:column;gap:10px">
              <button class="duration-btns" style="width:100%;text-align:left;padding:12px" onclick="quickSelectGift('GOLDV2_1')">
                ğŸª™ 450 Gems (â‚¬2.99 value)
              </button>
              <button class="duration-btns" style="width:100%;text-align:left;padding:12px" onclick="quickSelectGift('GOLDV2_2')">
                ğŸª™ 3400 Gems (â‚¬19.99 value)
              </button>
              <button class="duration-btns" style="width:100%;text-align:left;padding:12px" onclick="quickSelectGift('BUNDLE_STARTER_PACK')">
                ğŸ”¥ Starter Pack (â‚¬6.49 value)
              </button>
              <button class="duration-btns" style="width:100%;text-align:left;padding:12px" onclick="quickSelectGift('BATTLE_PASS')">
                ğŸ‘‘ Battle Pass (â‚¬4.49 value)
              </button>
              <button class="duration-btns" style="width:100%;text-align:left;padding:12px" onclick="quickSelectGift('calendar-newyear-2026')">
                ğŸ“… New Year Calendar (â‚¬3.99 value)
              </button>
            </div>
            
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,215,0,0.2)">
              <div style="font-weight:700;color:var(--gold);margin-bottom:10px">ğŸ’¡ Tips</div>
              <ul style="color:var(--muted);font-size:0.9rem;padding-left:20px;line-height:1.6">
                <li>Gifts are delivered instantly</li>
                <li>No payment required</li>
                <li>All shop items available</li>
                <li>User must exist in-game</li>
              </ul>
            </div>
          </aside>
        </div>
      </div>
      
      
      <div class="card" style="margin-top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <h3 style="margin:0">ğŸ“œ Recent Gifts Sent</h3>
          <button class="primary" onclick="fetchGiftHistory()" style="padding:8px 16px;font-size:0.9rem">ğŸ”„ Refresh</button>
        </div>
        <div style="max-height:400px;overflow-y:auto">
          <table id="giftHistoryTable">
            <thead>
              <tr><th>Date</th><th>Recipient</th><th>Item</th><th>Value</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    
    
    <div id="connectivity" class="section">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="font-weight:700;font-size:1.2rem">ğŸ”” Ping & Logs</div>
          <div class="small muted">Controls and monitoring</div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
          <div><div class="small muted">URL</div><div class="pill" id="pingUrl">â€”</div></div>
          <div><div class="small muted">Status</div><div id="pingStatus" class="pill">â€”</div></div>
          <div><div class="small muted">Last</div><div id="pingLast" class="small">â€”</div></div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="primary" id="manualPing">Manual Ping</button>
            <button class="primary" id="togglePing">Enable / Disable</button>
            <button class="primary" id="refreshLogs">Refresh</button>
          </div>
        </div>
        <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:300px;max-height:300px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px">
            <div style="font-weight:700;margin-bottom:12px">Recent Logs</div>
            <div id="logsList"></div>
          </div>
          <div style="width:350px;min-width:300px;max-height:300px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:700">Recent Connections</div>
              <div class="small muted">Bot access</div>
            </div>
            <div id="recentList"></div>
          </div>
        </div>
      </div>
    </div>

    
    <div id="roses-gems" class="section">
      <div class="card">
        <h2>ğŸŒ¹ Roses & Gems Purchases</h2>
        <p style="color:var(--muted);margin-bottom:20px">Manage manual payment purchases</p>
        
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="border-bottom:2px solid var(--accent)">
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Username</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Email</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Item</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Currency</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Price</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Platform</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Status</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Date</th>
                <th style="text-align:center;padding:12px;color:var(--accent);font-weight:600">Action</th>
              </tr>
            </thead>
            <tbody id="rosesGemsTable">
              <tr>
                <td colspan="9" style="text-align:center;padding:30px;color:var(--muted)">Loading purchases...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="paypal-purchases" class="section">
      <div class="card">
        <h2>ğŸ’³ PayPal Purchases</h2>
        <p style="color:var(--muted);margin-bottom:20px">Track all PayPal payment transactions</p>
        
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="border-bottom:2px solid var(--accent)">
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Username</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Email</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Item</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Amount</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Currency</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Status</th>
                <th style="text-align:left;padding:12px;color:var(--accent);font-weight:600">Date</th>
              </tr>
            </thead>
            <tbody id="paypalTable">
              <tr>
                <td colspan="7" style="text-align:center;padding:30px;color:var(--muted)">Loading purchases...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="testimonials" class="section">
      <div class="card">
        <div class="grid">
          <div class="list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:700;font-size:1.2rem">â­ Testimonials</div>
              <div class="pill" id="testimonialsCount">0 reviews</div>
            </div>
            <table id="testimonialsTable">
              <thead>
                <tr><th>User</th><th>Rating</th><th>Comment</th><th>Date</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <aside style="padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <div style="font-weight:700;margin-bottom:12px;font-size:1.1rem">Add Testimonial</div>
            <div class="small muted" style="margin-bottom:16px">Create a new review</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <label style="color:var(--muted);font-size:13px">Username</label>
              <input id="testimonialUsername" placeholder="Player username" />
              
              <label style="color:var(--muted);font-size:13px">Rating</label>
              <select id="testimonialRating">
                <option value="5" selected>â­â­â­â­â­ (5 stars)</option>
                <option value="4">â­â­â­â­â˜† (4 stars)</option>
                <option value="3">â­â­â­â˜†â˜† (3 stars)</option>
                <option value="2">â­â­â˜†â˜†â˜† (2 stars)</option>
                <option value="1">â­â˜†â˜†â˜†â˜† (1 star)</option>
              </select>
              
              <label style="color:var(--muted);font-size:13px">Comment</label>
              <textarea id="testimonialComment" placeholder="Review text..."></textarea>
              
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--muted);font-size:14px;margin-top:5px">
                <input type="checkbox" id="testimonialAnonymous" style="width:auto;cursor:pointer" />
                <span>Anonymous (hide username)</span>
              </label>
              
              <button class="primary" id="addTestimonialBtn" style="background:linear-gradient(90deg,var(--gold),#ffed4e);color:#000">âœ¨ Add Review</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    
    <div id="stats" class="section">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">ğŸ“Š Usage Statistics</h2>
        <div class="chart-container">
          <div style="font-weight:700;margin-bottom:12px">Connections per user</div>
          <div id="statsChart"></div>
        </div>
      </div>
    </div>

    
    <div id="debug" class="section">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">ğŸ”§ Debug Information</h2>
        <p>Configuration status and environment variables:</p>
        <pre id="debugInfo" style="background:rgba(0,0,0,0.3);padding:16px;border-radius:8px;font-size:12px;overflow-x:auto">Loading...</pre>
        <button onclick="loadDebug()" style="margin-top:10px;background:var(--accent);border:none;padding:8px 16px;border-radius:6px;color:#000;font-weight:600;cursor:pointer">Refresh</button>
      </div>
      
      
      <div class="card" style="margin-top:20px">
        <h2 style="margin-top:0;color:var(--accent)">ğŸ“¢ Custom Authentication Message</h2>
        <p class="small muted" style="margin-bottom:16px">Set a custom message that will be shown to all users when they authenticate</p>
        <div style="display:flex;flex-direction:column;gap:12px">
          <textarea 
            id="customMessageInput" 
            rows="3" 
            placeholder="Enter your custom message here..."></textarea>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="primary" onclick="saveCustomMessage()">ğŸ’¾ Save Message</button>
            <button class="del" onclick="clearCustomMessage()">ğŸ—‘ï¸ Clear Message</button>
            <button class="primary" onclick="loadCustomMessage()" style="background:linear-gradient(90deg,var(--muted),#7b7b7b)">ğŸ”„ Refresh</button>
          </div>
          <div id="customMessageStatus" style="margin-top:8px;font-weight:600;color:var(--muted)"></div>
        </div>
      </div>

      
      <div class="card" style="margin-top:20px">
        <h2 style="margin-top:0;color:var(--accent)">ğŸ¤– Bot Version Management</h2>
        <p class="small muted" style="margin-bottom:16px">Set the latest bot version. Users will see "upToDate: false" if their version is outdated.</p>
        
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="form-group">
            <label>Latest Bot Version</label>
            <input 
              id="latestBotVersionInput" 
              placeholder="0.6.9"
              style="font-family:monospace;font-size:1.1rem" />
            <div class="small muted" style="margin-top:5px">Format: X.Y.Z or vX.Y.Z (example: 0.7.0 or v0.7.0)</div>
          </div>
          
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="primary" onclick="saveBotVersion()">ğŸ’¾ Set Latest Version</button>
            <button class="primary" onclick="loadBotVersion()" style="background:linear-gradient(90deg,var(--muted),#7b7b7b)">ğŸ”„ Refresh</button>
          </div>
          
          <div id="botVersionStatus" style="margin-top:8px;font-weight:600;color:var(--muted)"></div>
        </div>
        
        
        <div style="margin-top:30px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1)">
          <h3 style="margin-top:0">ğŸ“Š User Version Statistics</h3>
          <button class="primary" onclick="loadBotVersionStats()" style="margin-bottom:15px">ğŸ”„ Refresh Stats</button>
          <div id="botVersionStatsChart"></div>
        </div>
      </div>
    </div>

  <div id="toast" style="display:none" class="toast">Message</div>

  <script>
    const botVersionApi = {
      get: '/api/bot-version',
      set: '/api/bot-version/set',
      stats: '/api/users/bot-versions'
    };

    async function loadBotVersion(){
      try{
        const res = await fetch(botVersionApi.get, {credentials:'same-origin'});
        if(!res.ok){ 
          document.getElementById('botVersionStatus').textContent = 'Error loading version';
          document.getElementById('botVersionStatus').style.color = 'var(--danger)';
          document.getElementById('latestBotVersionInput').value = '';
          return; 
        }
        const data = await res.json();
        document.getElementById('latestBotVersionInput').value = data.latest_version || '';
        document.getElementById('botVersionStatus').textContent = `âœ… Current: ${data.latest_version}`;
        document.getElementById('botVersionStatus').style.color = 'var(--success)';
      }catch(e){
        console.error(e);
        document.getElementById('botVersionStatus').textContent = 'Error loading version';
        document.getElementById('botVersionStatus').style.color = 'var(--danger)';
      }
    }

    async function saveBotVersion(){
      const version = document.getElementById('latestBotVersionInput').value.trim();
      
      if(!version){
        toast('âŒ Version cannot be empty');
        return;
      }
      
      // Validate format
      const versionRegex = /^v?\d+\.\d+\.\d+$/;
      if(!versionRegex.test(version)){
        toast('âŒ Invalid format. Use X.Y.Z or vX.Y.Z (e.g., 0.7.0 or v0.7.0)');
        return;
      }
      
      try{
        const res = await fetch(botVersionApi.set, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({version}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Bot version updated');
          document.getElementById('botVersionStatus').textContent = `âœ… Updated to ${version}`;
          document.getElementById('botVersionStatus').style.color = 'var(--success)';
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
          document.getElementById('botVersionStatus').textContent = 'âŒ Failed to update version';
          document.getElementById('botVersionStatus').style.color = 'var(--danger)';
        }
      }catch(e){
        console.error(e);
        toast('Error saving version');
        document.getElementById('botVersionStatus').textContent = 'âŒ Error saving version';
        document.getElementById('botVersionStatus').style.color = 'var(--danger)';
      }
    }

    async function loadBotVersionStats(){
      try{
        const res = await fetch(botVersionApi.stats, {credentials:'same-origin'});
        if(!res.ok){ 
          document.getElementById('botVersionStatsChart').innerHTML = '<div class="small muted">Error loading stats</div>';
          return; 
        }
        const stats = await res.json();
        renderBotVersionStats(stats);
      }catch(e){
        console.error(e);
        document.getElementById('botVersionStatsChart').innerHTML = '<div class="small muted">Error loading stats</div>';
      }
    }

    function renderBotVersionStats(stats){
      const container = document.getElementById('botVersionStatsChart');
      container.innerHTML = '';
      
      if(stats.length === 0){
        container.innerHTML = '<div class="small muted">No version data yet</div>';
        return;
      }
      
      const total = stats.reduce((sum, s) => sum + s.count, 0);
      const max = Math.max(...stats.map(s => s.count));
      
      stats.forEach(({version, count}) => {
        const percentage = ((count / total) * 100).toFixed(1);
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.setProperty('--width', `${(count / max) * 100}%`);
        bar.innerHTML = `<span>${escapeHtml(version)}</span><span>${count} users (${percentage}%)</span>`;
        container.appendChild(bar);
      });
    }
    // Particles
    function createParticles(){
      const container = document.getElementById('particles');
      if (!container) return;
      for(let i=0;i<50;i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.position = 'absolute';
        p.style.background = '#00d4ff';
        p.style.borderRadius = '50%';
        p.style.opacity = '0.1';
        p.style.animation = 'float 10s infinite linear';
        p.style.left = Math.random()*100 + '%';
        p.style.width = p.style.height = Math.random()*4 + 2 + 'px';
        p.style.animationDelay = Math.random()*10 + 's';
        container.appendChild(p);
      }
    }
    createParticles();

    const api = {
      list: '/api/users',
      add: '/api/add',
      del: '/api/delete',
      extend: '/api/extend',
      ping: '/api/ping',
      pingStatus: '/api/ping/status',
      logs: '/api/logs',
      recent: '/api/recent',
      export: '/api/export',
      stats: '/api/stats',
      keys: '/api/keys',
      generateKey: '/api/keys/generate',
      deleteKey: '/api/keys/delete'
    };

    const testimonialsApi = {
      list: '/api/testimonials',
      add: '/api/testimonials/add',
      delete: '/api/testimonials/delete',
      approve: '/api/testimonials/approve'
    };
    
    const customMessageApi = {
      get: '/api/custom-message',
      set: '/api/custom-message/set',
      clear: '/api/custom-message/clear'
    };

    const couponsApi = {
      list: '/api/admin/coupons',
      create: '/api/admin/coupons/create',
      toggle: '/api/admin/coupons/toggle',
      delete: '/api/admin/coupons/delete'
    };

    const gemAccountsApi = {
      list: '/api/gem-accounts',
      add: '/api/gem-accounts/add',
      recharge: '/api/gem-accounts/recharge',
      toggle: '/api/gem-accounts/toggle',
      delete: '/api/gem-accounts/delete',
      stats: '/api/gem-accounts/stats'
    };

    const giftsApi = {
      send: '/api/admin/gifts/send',
      history: '/api/admin/gifts/history'
    };

    // Gift products catalog (matches shop items)
    const GIFT_CATALOG = {
      gems: [
        { id: 'GOLDV2_1', name: '450 Gems', value: 'â‚¬2.99' },
        { id: 'GOLDV2_2', name: '3400 Gems', value: 'â‚¬19.99' },
        { id: 'GOLDV2_3', name: '9000 Gems', value: 'â‚¬49.99' }
      ],
      bundles: [
        { id: 'BUNDLE_STARTER_PACK', name: 'Starter Pack (1250 gems)', value: 'â‚¬6.49' },
        { id: 'BUNDLE_ANGELXMAS', name: 'Angel Xmas Bundle', value: 'â‚¬2.99' },
        { id: 'BUNDLE_DARK_CUPID', name: 'Dark Cupid Bundle', value: 'â‚¬4.99' },
        { id: 'BUNDLE_WATERMELON', name: 'Watermelon Bundle', value: 'â‚¬4.99' }
      ],
      calendars: [
        { id: 'calendar-newyear-2026', name: 'New Year 2026 Calendar', value: 'â‚¬3.99' },
        { id: 'calendar-eggventure-2025', name: 'Eggventure Calendar', value: 'â‚¬3.99' }
      ],
      premium: [
        { id: 'BATTLE_PASS', name: 'Battle Pass', value: 'â‚¬4.49' },
        { id: 'BATTLE_PASS_BUNDLE', name: 'Battle Pass Bundle', value: 'â‚¬8.99' },
        { id: 'CUSTOM_GAMES_PREMIUM', name: 'Custom Games Premium', value: 'â‚¬19.99' }
      ]
    };

    function toast(msg, t=3000){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(window._toastTimeout);
      window._toastTimeout = setTimeout(()=> el.style.display='none', t);
    }

    function switchSection(section){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(section).classList.add('active');
      document.querySelector(`[data-section="${section}"]`).classList.add('active');
      
      // Load data when switching to specific sections
      if(section === 'keys') {
        fetchKeys();
      } else if(section === 'testimonials') {
        fetchTestimonials();
      } else if(section === 'coupons') {
        fetchCoupons();
      } else if(section === 'gem-accounts') {
        fetchGemAccounts();
      } else if(section === 'send-gifts') {
        fetchGiftHistory();
      } else if(section === 'roses-gems') {
        loadRosesGemsPurchases();
      } else if(section === 'paypal-purchases') {
        loadPayPalPurchases();
      }
    }

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.onclick = () => switchSection(btn.dataset.section);
    });

    // Existing functions for users, keys, connectivity, etc. (unchanged)
    async function fetchPingStatus(){
      try{
        const res = await fetch(api.pingStatus, {credentials:'same-origin'});
        if(!res.ok) return;
        const s = await res.json();
        document.getElementById('pingUrl').textContent = s.url || 'â€”';
        document.getElementById('pingStatus').textContent = s.enabled ? 'Enabled' : 'Disabled';
        document.getElementById('pingLast').textContent = s.last_time ? `${s.last_time} ${s.last_code?('â†’ '+s.last_code):''}` : 'â€”';
      }catch(e){ console.warn(e) }
    }

    async function manualPing(){
      try{
        const res = await fetch(api.ping, {method:'POST', credentials:'same-origin'});
        const j = await res.json().catch(()=>({}));
        if(res.ok){ toast(`Ping ok ${j.status}`); } else { toast('Ping failed: '+(j.error||res.status)); }
        await fetchPingStatus();
        await fetchLogs();
        await fetchRecent();
      }catch(e){ toast('Ping error'); }
    }

    async function togglePingHandler(){
      try{
        const sres = await fetch(api.pingStatus, {credentials:'same-origin'});
        const s = await sres.json();
        const enable = !s.enabled;
        const res = await fetch('/api/ping/toggle', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({enabled: enable})
        });
        const j = await res.json().catch(()=>({}));
        if(res.ok){ toast('OK'); } else { toast('Erreur: '+(j.error||res.status)); }
        await fetchPingStatus();
        await fetchLogs();
        await fetchRecent();
      }catch(e){ toast('Erreur'); }
    }

    async function fetchLogs(){
      try{
        const res = await fetch(api.logs, {credentials:'same-origin'});
        if(!res.ok) return;
        const list = await res.json();
        const container = document.getElementById('logsList');
        container.innerHTML = '';
        list.slice(0,20).forEach(item => {
          const el = document.createElement('div');
          el.className = 'log-item';
          if(typeof item === 'object' && item !== null){
            const lvl = (item.level||'info').toLowerCase();
            el.innerHTML = `
              <div class="log-meta">${escapeHtml(item.ts)}</div>
              <div style="flex:1">
                <div class="small muted"> <span class="badge-${lvl}">[${lvl.toUpperCase()}]</span> ${escapeHtml(item.msg)}</div>
              </div>
            `;
          }
          container.appendChild(el);
        });
      }catch(e){ console.warn(e) }
    }

    async function fetchRecent(){
      try{
        const res = await fetch(api.recent, {credentials:'same-origin'});
        if(!res.ok) return;
        const list = await res.json();
        const container = document.getElementById('recentList');
        container.innerHTML = '';
        list.slice(0,20).forEach(r => {
          const div = document.createElement('div');
          div.className = 'recent-item';
          const avatar = document.createElement('div');
          avatar.className = 'recent-avatar';
          avatar.textContent = (r.username||'?').charAt(0).toUpperCase();
          const body = document.createElement('div');
          body.className = 'recent-body';
          body.innerHTML = `<div><strong>${escapeHtml(r.username||'â€”')}</strong> <span class="small muted">@${escapeHtml(r.ip||'â€”')}</span></div><div class="recent-time">${escapeHtml(r.ts)} â€¢ <span class="small muted">${escapeHtml(r.status)}</span></div>`;
          div.appendChild(avatar);
          div.appendChild(body);
          container.appendChild(div);
        });
      }catch(e){ console.warn(e) }
    }

    async function fetchStats(){
      try{
        const res = await fetch(api.stats, {credentials:'same-origin'});
        if(!res.ok) return;
        const stats = await res.json();
        renderStats(stats);
      }catch(e){ console.warn(e) }
    }

    function renderStats(stats){
      const container = document.getElementById('statsChart');
      container.innerHTML = '';
      if(stats.length === 0){
        container.innerHTML = '<div class="small muted">No data</div>';
        return;
      }
      const max = Math.max(...stats.map(s => s[1]));
      stats.forEach(([user, count]) => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.setProperty('--width', `${(count / max) * 100}%`);
        bar.innerHTML = `<span>${escapeHtml(user)}</span><span>${count}</span>`;
        container.appendChild(bar);
      });
    }

    async function loadDebug(){
      try{
        const res = await fetch('/debug', {credentials:'same-origin'});
        if(!res.ok) return;
        const info = await res.json();
        document.getElementById('debugInfo').textContent = JSON.stringify(info, null, 2);
      }catch(e){ 
        document.getElementById('debugInfo').textContent = 'Error loading debug info: ' + e.message;
      }
    }

    document.getElementById('exportBtn').onclick = ()=> { window.location = api.export };
    document.getElementById('manualPing').onclick = manualPing;
    document.getElementById('togglePing').onclick = togglePingHandler;
    document.getElementById('refreshLogs').onclick = async () => { await fetchLogs(); await fetchRecent(); };

    document.getElementById('search').oninput = function(){
      const q = this.value.toLowerCase().trim();
      document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
        const uname = tr.querySelector('td strong')?.textContent?.toLowerCase() || '';
        tr.style.display = uname.includes(q) ? '' : 'none';
      });
    }

    document.getElementById('filter').onchange = fetchUsers;

    async function fetchUsers(){
      const res = await fetch(api.list, {credentials:'same-origin'});
      if(!res.ok){ toast('Erreur: '+res.status); return; }
      const users = await res.json();
      renderUsers(users);
      updateMainStats(users);
    }

    function updateMainStats(users){
      const total = users.length;
      const active = users.filter(u => new Date(u.expires) > new Date()).length;
      const expired = total - active;
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('activeUsers').textContent = active;
      document.getElementById('expiredUsers').textContent = expired;
      // Total connections from stats
      fetch(api.stats, {credentials:'same-origin'}).then(res => res.json()).then(stats => {
        const totalConn = stats.reduce((sum, [,count]) => sum + count, 0);
        document.getElementById('totalConnections').textContent = totalConn;
      }).catch(() => document.getElementById('totalConnections').textContent = 'â€”');
      
      // Load coupon and gem account counts
      fetch(couponsApi.list, {credentials:'same-origin'}).then(res => res.json()).then(coupons => {
        const activeCoupons = coupons.filter(c => c.is_active).length;
        document.getElementById('totalCoupons').textContent = activeCoupons;
      }).catch(() => document.getElementById('totalCoupons').textContent = 'â€”');
      
      fetch(gemAccountsApi.stats, {credentials:'same-origin'}).then(res => res.json()).then(stats => {
        document.getElementById('totalGemAccounts').textContent = stats.total_accounts;
      }).catch(() => document.getElementById('totalGemAccounts').textContent = 'â€”');
    }

    function renderUsers(users){
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      let count = 0;
      let active = 0;
      let expired = 0;
      
      const filter = document.getElementById('filter').value;
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      users.forEach(u=>{
        const expires = u.expires || 'â€”';
        const expiryDate = new Date(expires);
        const isExpired = expiryDate < now;
        const lastConn = u.last_connected ? new Date(u.last_connected.substring(0,10)) : null;
        const isRecent = lastConn && lastConn > sevenDaysAgo;
        
        // Apply filter
        let show = true;
        if(filter === 'active' && isExpired) show = false;
        else if(filter === 'expired' && !isExpired) show = false;
        else if(filter === 'recent' && !isRecent) show = false;
        
        if(!show) return;
        
        count++;
        const tr = document.createElement('tr');
        
        const expiryClass = isExpired ? 'expired' : 'active';
        if(isExpired) expired++; else active++;
        
        const lastConnDisplay = u.last_connected ? u.last_connected.substring(0,10) : 'Never';
        
        tr.innerHTML = `
          <td><strong>${escapeHtml(u.username)}</strong></td>
          <td class="small muted">${lastConnDisplay}</td>
          <td class="${expiryClass}">${expires}</td>
          <td class="actions">
            <button class="extend-btn" onclick="quickExtend('${escapeHtml(u.username)}', 7)">+7j</button>
            <button class="extend-btn" onclick="quickExtend('${escapeHtml(u.username)}', 30)">+1m</button>
            <button class="del" data-username="${u.username}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('count').textContent = count;
      document.getElementById('activeCount').textContent = active + ' active';
      document.getElementById('expiredCount').textContent = expired + ' expired';
      
      // attach delete handlers
      document.querySelectorAll('.del').forEach(btn=>{
        btn.onclick = async ()=> {
          const username = btn.dataset.username;
          if(!confirm(`Delete ${username}?`)) return;
          const res = await fetch(api.del, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username}),
            credentials:'same-origin'
          });
          if(res.ok){
            toast('Deleted');
            btn.closest('tr').style.transition='opacity .4s';
            btn.closest('tr').style.opacity='0';
            setTimeout(fetchUsers, 420);
          } else {
            const j = await res.json().catch(()=>({}));
            toast('Error: ' + (j.error || res.status));
          }
        }
      })
    }

    async function extendUser(days){
      const username = document.getElementById('extendUsername').value.trim();
      if(!username){ toast('Username required'); return; }
      
      const res = await fetch(api.extend, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, days}),
        credentials:'same-origin'
      });
      
      if(res.ok){
        const result = await res.json();
        toast(`âœ… +${days}j for ${username}\nNew date: ${result.newExpires}`);
        document.getElementById('extendUsername').value = '';
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('âŒ ' + (j.error || 'Error'));
      }
    }

    async function quickExtend(username, days){
      if(!confirm(`Extend ${username} by ${days} days?`)) return;
      
      const res = await fetch(api.extend, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, days}),
        credentials:'same-origin'
      });
      
      if(res.ok){
        const result = await res.json();
        toast(`âœ… Extended until ${result.newExpires}`);
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('âŒ ' + (j.error || 'Error'));
      }
    }

    // Keys functions
    async function fetchKeys(){
      try{
        const res = await fetch(api.keys, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading keys'); return; }
        const keys = await res.json();
        renderKeys(keys);
      }catch(e){ 
        console.error(e);
        toast('Error loading keys');
      }
    }

    function renderKeys(keys){
      const tbody = document.querySelector('#keysTable tbody');
      tbody.innerHTML = '';
      document.getElementById('keysCount').textContent = keys.length + ' keys';
      
      if(keys.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No keys yet</td></tr>';
        return;
      }
      
      keys.forEach(k => {
        const tr = document.createElement('tr');
        const statusClass = k.used ? 'key-status-used' : 'key-status-unused';
        const statusText = k.used ? `Used by ${k.used_by || '?'} on ${k.used_at || '?'}` : 'Unused';
        
        tr.innerHTML = `
          <td><span class="key-code">${escapeHtml(k.code)}</span></td>
          <td>${k.duration} days</td>
          <td class="small muted">${k.created ? k.created.substring(0,10) : 'â€”'}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="actions">
            <button class="copy-btn" onclick="copyKey('${escapeHtml(k.code)}')">ğŸ“‹ Copy</button>
            ${!k.used ? `<button class="del" onclick="deleteKey('${escapeHtml(k.code)}')">Delete</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function generateKey(){
      const duration = parseInt(document.getElementById('keyDuration').value);
      
      if(!duration || duration <= 0){
        toast('Invalid duration');
        return;
      }
      
      try{
        const res = await fetch(api.generateKey, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({duration}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          const result = await res.json();
          toast(`âœ¨ Key generated: ${result.key.code}`);
          await fetchKeys();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error generating key');
      }
    }

    async function deleteKey(code){
      if(!confirm(`Delete key ${code}?`)) return;
      
      try{
        const res = await fetch(api.deleteKey, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('Key deleted');
          await fetchKeys();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error deleting key');
      }
    }

    function copyKey(code){
      navigator.clipboard.writeText(code).then(() => {
        toast(`âœ… Copied: ${code}`);
      }).catch(() => {
        toast('âŒ Failed to copy');
      });
    }

    document.getElementById('generateKeyBtn').onclick = generateKey;

    // Coupons functions
    async function fetchCoupons(){
      try{
        const res = await fetch(couponsApi.list, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading coupons'); return; }
        const coupons = await res.json();
        renderCoupons(coupons);
      }catch(e){
        console.error(e);
        toast('Error loading coupons');
      }
    }

    function renderCoupons(coupons){
      const tbody = document.querySelector('#couponsTable tbody');
      tbody.innerHTML = '';
      document.getElementById('couponsCount').textContent = coupons.length + ' coupons';
      
      if(coupons.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No coupons yet</td></tr>';
        return;
      }
      
      coupons.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong style="color:var(--gold);font-family:monospace">${c.code}</strong></td>
          <td>${c.discount_percent}%</td>
          <td>${c.times_used}${c.max_uses?` / ${c.max_uses}`:''}</td>
          <td><span class="badge ${c.is_active?'badge-active':'badge-inactive'}">${c.is_active?'Active':'Inactive'}</span></td>
          <td class="small muted">${c.expires_at||'Never'}</td>
          <td class="actions">
            <button class="btn-sm ${c.is_active?'btn-danger':'btn-success'}" onclick="toggleCoupon('${c.code}',${!c.is_active})">${c.is_active?'Disable':'Enable'}</button>
            <button class="btn-sm btn-danger" onclick="deleteCoupon('${c.code}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function createCoupon(){
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      const discount = parseInt(document.getElementById('couponDiscount').value);
      const maxUses = document.getElementById('couponMaxUses').value ? parseInt(document.getElementById('couponMaxUses').value) : null;
      const expires = document.getElementById('couponExpires').value;
      
      if(!code || !discount){
        toast('Code and discount required');
        return;
      }
      
      if(discount < 1 || discount > 100){
        toast('Discount must be 1-100%');
        return;
      }
      
      try{
        const res = await fetch(couponsApi.create, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code, discount_percent: discount, max_uses: maxUses, expires_at: expires||null}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Coupon created!');
          document.getElementById('couponCode').value = '';
          document.getElementById('couponDiscount').value = '';
          document.getElementById('couponMaxUses').value = '';
          document.getElementById('couponExpires').value = '';
          await fetchCoupons();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error creating coupon');
      }
    }

    async function toggleCoupon(code, isActive){
      try{
        const res = await fetch(couponsApi.toggle, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code, is_active: isActive}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          await fetchCoupons();
        } else {
          toast('âŒ Error');
        }
      }catch(e){
        toast('âŒ Error');
      }
    }

    async function deleteCoupon(code){
      if(!confirm(`Delete coupon ${code}?`)) return;
      
      try{
        const res = await fetch(couponsApi.delete, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          await fetchCoupons();
        } else {
          toast('âŒ Error');
        }
      }catch(e){
        toast('âŒ Error');
      }
    }

    document.getElementById('createCouponBtn').onclick = createCoupon;

    // Gem Accounts functions
    async function fetchGemAccounts(){
      try{
        const res = await fetch(gemAccountsApi.list, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading gem accounts'); return; }
        const accounts = await res.json();
        renderGemAccounts(accounts);
      }catch(e){
        console.error(e);
        toast('Error loading gem accounts');
      }
    }

    function renderGemAccounts(accounts){
      const tbody = document.querySelector('#gemAccountsTable tbody');
      tbody.innerHTML = '';
      const active = accounts.filter(a => a.is_active).length;
      document.getElementById('gemAccountsCount').textContent = accounts.length + ' accounts';
      document.getElementById('gemAccountsActive').textContent = active + ' active';
      
      if(accounts.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No gem accounts yet</td></tr>';
        return;
      }
      
      accounts.forEach(a => {
        const gemsClass = a.gems_remaining < 1000 ? 'gems-low' : a.gems_remaining < 3000 ? 'gems-medium' : 'gems-high';
        const statusClass = a.is_active ? 'status-active' : 'status-inactive';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.account_number}</td>
          <td>${a.email}</td>
          <td>${a.current_nickname || 'â€”'}</td>
          <td class="${gemsClass}">${a.gems_remaining.toLocaleString()}</td>
          <td class="${statusClass}">${a.is_active ? 'Active' : 'Inactive'}</td>
          <td class="actions">
            <button class="btn-success btn-sm" onclick="rechargeGemAccount(${a.id})">Recharge</button>
            <button class="btn-sm ${a.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleGemAccount(${a.id}, ${!a.is_active})">${a.is_active ? 'Disable' : 'Enable'}</button>
            <button class="btn-danger btn-sm" onclick="deleteGemAccount(${a.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addGemAccount(){
      const number = parseInt(document.getElementById('gemAccountNumber').value);
      const email = document.getElementById('gemAccountEmail').value.trim();
      const password = document.getElementById('gemAccountPassword').value.trim();
      
      if(!number || !email || !password){
        toast('All fields required');
        return;
      }
      
      try{
        const res = await fetch(gemAccountsApi.add, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({account_number: number, email, password}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Gem account added!');
          document.getElementById('gemAccountNumber').value = '';
          document.getElementById('gemAccountEmail').value = '';
          document.getElementById('gemAccountPassword').value = '';
          await fetchGemAccounts();
          updateMainStats(await(await fetch(api.list, {credentials:'same-origin'})).json());
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error adding gem account');
      }
    }

    async function rechargeGemAccount(id){
      const amount = prompt('Enter gems amount (default: 5000):', '5000');
      if(!amount) return;
      
      try{
        const res = await fetch(gemAccountsApi.recharge, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({account_id: id, gems_amount: parseInt(amount)}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Account recharged!');
          await fetchGemAccounts();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        toast('âŒ Error');
      }
    }

    async function toggleGemAccount(id, isActive){
      try{
        const res = await fetch(gemAccountsApi.toggle, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({account_id: id, is_active: isActive}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          await fetchGemAccounts();
        } else {
          toast('âŒ Error');
        }
      }catch(e){
        toast('âŒ Error');
      }
    }

    async function deleteGemAccount(id){
      if(!confirm('Delete this gem account?')) return;
      
      try{
        const res = await fetch(gemAccountsApi.delete, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({account_id: id}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Account deleted!');
          await fetchGemAccounts();
          updateMainStats(await(await fetch(api.list, {credentials:'same-origin'})).json());
        } else {
          toast('âŒ Error');
        }
      }catch(e){
        toast('âŒ Error');
      }
    }

    document.getElementById('addGemAccountBtn').onclick = addGemAccount;

    // Gift sending functions
    function updateGiftForm(){
      const giftType = document.getElementById('giftType').value;
      const container = document.getElementById('giftFormContainer');
      
      if(!giftType){
        container.innerHTML = '';
        return;
      }
      
      let options = '';
      if(giftType === 'custom'){
        container.innerHTML = `
          <div class="form-group">
            <label>Custom Item ID</label>
            <input id="customItemId" placeholder="e.g., GOLDV2_1, BUNDLE_STRAWBERRY" />
          </div>
          <div class="form-group">
            <label>Item Name (for display)</label>
            <input id="customItemName" placeholder="e.g., 450 Gems Package" />
          </div>
        `;
        return;
      }
      
      const catalog = GIFT_CATALOG[giftType] || [];
      options = catalog.map(item => 
        `<option value="${item.id}">${item.name} - ${item.value}</option>`
      ).join('');
      
      container.innerHTML = `
        <div class="form-group">
          <label>Select Item</label>
          <select id="giftItemSelect">
            <option value="">-- Choose Item --</option>
            ${options}
          </select>
        </div>
      `;
    }

    function quickSelectGift(itemId){
      // Find item in catalog
      let foundItem = null;
      let foundType = null;
      
      for(const [type, items] of Object.entries(GIFT_CATALOG)){
        const item = items.find(i => i.id === itemId);
        if(item){
          foundItem = item;
          foundType = type;
          break;
        }
      }
      
      if(!foundItem) return;
      
      // Set form values
      document.getElementById('giftType').value = foundType;
      updateGiftForm();
      
      setTimeout(() => {
        const select = document.getElementById('giftItemSelect');
        if(select){
          select.value = itemId;
        }
      }, 100);
      
      toast('ğŸ“‹ Gift selected: ' + foundItem.name);
    }

    async function sendGift(){
      const username = document.getElementById('giftUsername').value.trim();
      const giftType = document.getElementById('giftType').value;
      const message = document.getElementById('giftMessage').value.trim();
      
      if(!username){
        toast('âŒ Username required');
        return;
      }
      
      if(!giftType){
        toast('âŒ Please select a gift type');
        return;
      }
      
      let itemId, itemName;
      
      if(giftType === 'custom'){
        itemId = document.getElementById('customItemId').value.trim();
        itemName = document.getElementById('customItemName').value.trim();
        
        if(!itemId || !itemName){
          toast('âŒ Custom item ID and name required');
          return;
        }
      } else {
        const select = document.getElementById('giftItemSelect');
        if(!select || !select.value){
          toast('âŒ Please select an item');
          return;
        }
        
        itemId = select.value;
        itemName = select.options[select.selectedIndex].text;
      }
      
      if(!confirm(`Send "${itemName}" to ${username}?\n\nThis is a FREE gift (no payment required).`)){
        return;
      }
      
      try{
        const res = await fetch(giftsApi.send, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            username,
            item_id: itemId,
            item_name: itemName,
            message: message || null
          }),
          credentials:'same-origin'
        });
        
        if(res.ok){
          const result = await res.json();
          toast('âœ… Gift sent successfully!');
          
          // Clear form
          document.getElementById('giftUsername').value = '';
          document.getElementById('giftType').value = '';
          document.getElementById('giftMessage').value = '';
          updateGiftForm();
          
          // Refresh history
          await fetchGiftHistory();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Failed to send gift'));
        }
      }catch(e){
        console.error(e);
        toast('âŒ Error sending gift');
      }
    }

    async function fetchGiftHistory(){
      try{
        const res = await fetch(giftsApi.history, {credentials:'same-origin'});
        if(!res.ok) return;
        
        const history = await res.json();
        renderGiftHistory(history);
      }catch(e){
        console.error(e);
      }
    }

    function renderGiftHistory(history){
      const tbody = document.querySelector('#giftHistoryTable tbody');
      tbody.innerHTML = '';
      
      if(history.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No gifts sent yet</td></tr>';
        return;
      }
      
      history.slice(0, 50).forEach(gift => {
        const tr = document.createElement('tr');
        const statusClass = gift.status === 'delivered' ? 'status-active' : 'status-inactive';
        
        tr.innerHTML = `
          <td class="small muted">${gift.sent_at || 'â€”'}</td>
          <td><strong>${escapeHtml(gift.recipient_username)}</strong></td>
          <td>${escapeHtml(gift.item_name)}</td>
          <td class="small muted">${gift.item_value || 'â€”'}</td>
          <td><span class="${statusClass}">${gift.status || 'pending'}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Testimonials management
    async function fetchTestimonials(){
      try{
        const res = await fetch(testimonialsApi.list, {credentials:'same-origin'});
        if(!res.ok){ toast('Error loading testimonials'); return; }
        const testimonials = await res.json();
        renderTestimonials(testimonials);
        updatePendingBadge(testimonials);
      }catch(e){
        console.error(e);
        toast('Error loading testimonials');
      }
    }
    
    function renderTestimonials(testimonials){
      const tbody = document.querySelector('#testimonialsTable tbody');
      tbody.innerHTML = '';
      
      const pending = testimonials.filter(t => !t.approved);
      const approved = testimonials.filter(t => t.approved);
      
      document.getElementById('testimonialsCount').textContent = `${testimonials.length} reviews (${pending.length} pending)`;
      
      if(testimonials.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No testimonials yet</td></tr>';
        return;
      }
      
      [...pending, ...approved].forEach(t => {
        const tr = document.createElement('tr');
        const stars = 'â­'.repeat(t.rating);
        const displayName = t.anonymous ? 'ğŸ•¶ï¸ Anonymous' : t.username;
        const truncatedComment = t.comment.length > 50 ? t.comment.substring(0, 50) + '...' : t.comment;
        const statusBadge = t.approved ? 
          '<span style="color:var(--success);font-weight:600">âœ“ Approved</span>' : 
          '<span style="color:#ff9b9b;font-weight:600">â³ Pending</span>';
        
        tr.innerHTML = `
          <td><strong>${escapeHtml(displayName)}</strong><br><small>${statusBadge}</small></td>
          <td>${stars}</td>
          <td class="small muted" title="${escapeHtml(t.comment)}">${escapeHtml(truncatedComment)}</td>
          <td class="small muted">${t.date}</td>
          <td class="actions">
            ${!t.approved ? `<button class="extend-btn" onclick="approveTestimonial('${escapeHtml(t.id)}')">âœ“ Approve</button>` : ''}
            <button class="del" onclick="deleteTestimonial('${escapeHtml(t.id)}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updatePendingBadge(testimonials){
      const pending = testimonials.filter(t => !t.approved);
      const btn = document.getElementById('pendingTestimonialsBtn');
      const badge = document.getElementById('pendingBadge');
      
      if(pending.length > 0){
        btn.style.display = 'flex';
        btn.classList.add('has-pending');
        badge.textContent = pending.length;
      } else {
        btn.style.display = 'flex';
        btn.classList.remove('has-pending');
        badge.textContent = '0';
      }
    }
    
    async function approveTestimonial(id){
      try{
        const res = await fetch(testimonialsApi.approve, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Testimonial approved');
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error approving testimonial');
      }
    }
    
    document.getElementById('addTestimonialBtn').onclick = async () => {
      const username = document.getElementById('testimonialUsername').value.trim();
      const rating = parseInt(document.getElementById('testimonialRating').value);
      const comment = document.getElementById('testimonialComment').value.trim();
      const anonymous = document.getElementById('testimonialAnonymous').checked;
      
      if(!username){ toast('Username required'); return; }
      if(!comment){ toast('Comment required'); return; }
      
      try{
        const res = await fetch(testimonialsApi.add, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({username, rating, comment, anonymous}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Testimonial added');
          document.getElementById('testimonialUsername').value = '';
          document.getElementById('testimonialComment').value = '';
          document.getElementById('testimonialAnonymous').checked = false;
          document.getElementById('testimonialRating').value = '5';
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error adding testimonial');
      }
    };
    
    async function deleteTestimonial(id){
      if(!confirm('Delete this testimonial?')) return;
      
      try{
        const res = await fetch(testimonialsApi.delete, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('Testimonial deleted');
          await fetchTestimonials();
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
        }
      }catch(e){
        console.error(e);
        toast('Error deleting testimonial');
      }
    }

    // Custom Message functions
    async function loadCustomMessage(){
      try{
        const res = await fetch(customMessageApi.get, {credentials:'same-origin'});
        if(!res.ok){ 
          document.getElementById('customMessageStatus').textContent = 'No custom message set';
          document.getElementById('customMessageInput').value = '';
          return; 
        }
        const data = await res.json();
        document.getElementById('customMessageInput').value = data.message || '';
        document.getElementById('customMessageStatus').textContent = data.message ? 'âœ… Message loaded' : 'No custom message set';
        document.getElementById('customMessageStatus').style.color = 'var(--success)';
      }catch(e){
        console.error(e);
        document.getElementById('customMessageStatus').textContent = 'Error loading message';
        document.getElementById('customMessageStatus').style.color = 'var(--danger)';
      }
    }
    
    async function saveCustomMessage(){
      const message = document.getElementById('customMessageInput').value.trim();
      
      if(!message){
        toast('âŒ Message cannot be empty');
        return;
      }
      
      try{
        const res = await fetch(customMessageApi.set, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message}),
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Custom message saved');
          document.getElementById('customMessageStatus').textContent = 'âœ… Message saved successfully';
          document.getElementById('customMessageStatus').style.color = 'var(--success)';
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
          document.getElementById('customMessageStatus').textContent = 'âŒ Failed to save message';
          document.getElementById('customMessageStatus').style.color = 'var(--danger)';
        }
      }catch(e){
        console.error(e);
        toast('Error saving message');
        document.getElementById('customMessageStatus').textContent = 'âŒ Error saving message';
        document.getElementById('customMessageStatus').style.color = 'var(--danger)';
      }
    }
    
    async function clearCustomMessage(){
      if(!confirm('Clear the custom message?')) return;
      
      try{
        const res = await fetch(customMessageApi.clear, {
          method:'POST',
          credentials:'same-origin'
        });
        
        if(res.ok){
          toast('âœ… Custom message cleared');
          document.getElementById('customMessageInput').value = '';
          document.getElementById('customMessageStatus').textContent = 'âœ… Message cleared';
          document.getElementById('customMessageStatus').style.color = 'var(--muted)';
        } else {
          const j = await res.json().catch(()=>({}));
          toast('âŒ ' + (j.error || 'Error'));
          document.getElementById('customMessageStatus').textContent = 'âŒ Failed to clear message';
          document.getElementById('customMessageStatus').style.color = 'var(--danger)';
        }
      }catch(e){
        console.error(e);
        toast('Error clearing message');
        document.getElementById('customMessageStatus').textContent = 'âŒ Error clearing message';
        document.getElementById('customMessageStatus').style.color = 'var(--danger)';
      }
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.getElementById('addBtn').onclick = async ()=>{
      const username = document.getElementById('username').value.trim();
      const duration = document.getElementById('duration').value;
      if(!username){ toast('Username required'); return; }
      const body = { username, duration: parseInt(duration) || 0 };
      const res = await fetch(api.add, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(body)
      });
      if(res.ok){
        toast('User added');
        document.getElementById('username').value = '';
        setTimeout(fetchUsers, 220);
      } else {
        const j = await res.json().catch(()=>({}));
        toast('Error: ' + (j.error || res.status));
      }
    }

    // ============ SHOP MANAGEMENT FUNCTIONS ============
    function switchShopTab(tabName) {
        document.querySelectorAll('#shop-management .content').forEach(el => el.style.display = 'none');
        document.getElementById('shop-' + tabName).style.display = 'block';
        
        // Load tab data
        if (tabName === 'gift-codes') loadGiftCodes();
        if (tabName === 'purchases') loadPurchases();
        if (tabName === 'likes') loadLikeStats();
        if (tabName === 'settings') loadPromoSettings();
    }

    async function loadPromoSettings() {
        try {
            const response = await fetch('/api/shop/settings');
            const data = await response.json();
            document.getElementById('promoEnabled').value = data.global_promo_enabled ? 'true' : 'false';
            document.getElementById('promoPercent').value = data.global_promo_percent || 0;
            document.getElementById('promoLabel').value = data.global_promo_label || '';
        } catch (error) {
            console.error('Error loading promo settings:', error);
        }
    }

    async function savePromoSettings() {
        try {
            const data = {
                global_promo_enabled: document.getElementById('promoEnabled').value === 'true',
                global_promo_percent: parseInt(document.getElementById('promoPercent').value) || 0,
                global_promo_label: document.getElementById('promoLabel').value
            };
            
            const response = await fetch('/api/admin/shop/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (response.ok) {
                showShopMessage('promoMessage', 'âœ… Settings saved successfully!', 'success');
            } else {
                showShopMessage('promoMessage', 'âŒ Error: ' + result.error, 'error');
            }
        } catch (error) {
            showShopMessage('promoMessage', 'âŒ Error saving settings', 'error');
        }
    }

    function updatePromoStatus() {
        // Real-time preview
    }

    async function createGiftCode() {
        const amount = document.getElementById('giftAmount').value;
        const expiry = document.getElementById('giftExpiry').value;
        
        if (!amount) {
            showShopMessage('giftCodeMessage', 'âŒ Please enter an amount', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/gift-codes/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    amount: parseFloat(amount),
                    expires_at: expiry || null
                })
            });
            
            const data = await response.json();
            if (response.ok) {
                showShopMessage('giftCodeMessage', `âœ… Code created: <strong>${data.code}</strong>`, 'success');
                document.getElementById('giftAmount').value = '';
                document.getElementById('giftExpiry').value = '';
                loadGiftCodes();
            } else {
                showShopMessage('giftCodeMessage', 'âŒ Error: ' + data.error, 'error');
            }
        } catch (error) {
            showShopMessage('giftCodeMessage', 'âŒ Error creating code', 'error');
        }
    }

    async function loadGiftCodes() {
        try {
            const response = await fetch('/api/admin/gift-codes');
            const data = await response.json();
            
            if (!data.codes || data.codes.length === 0) {
                document.getElementById('giftCodesList').innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No gift codes yet</div>';
                return;
            }
            
            let html = '<table style="width:100%;border-collapse:collapse"><thead><tr style="background:rgba(255,255,255,0.05)"><th style="padding:12px;text-align:left;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)">Code</th><th style="padding:12px;text-align:left;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)">Amount</th><th style="padding:12px;text-align:left;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)">Status</th><th style="padding:12px;text-align:left;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)">Redeemed By</th><th style="padding:12px;text-align:left;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)">Created</th></tr></thead><tbody>';
            data.codes.forEach(code => {
                html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <td style="padding:12px"><strong>${code.code}</strong></td>
                    <td style="padding:12px">â‚¬${code.amount.toFixed(2)}</td>
                    <td style="padding:12px">${code.is_redeemed ? '<span style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(255,71,87,0.2);color:var(--danger)">Redeemed</span>' : '<span style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(46,213,115,0.2);color:var(--success)">Available</span>'}</td>
                    <td style="padding:12px">${code.redeemed_by || '-'}</td>
                    <td style="padding:12px">${code.created_at}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('giftCodesList').innerHTML = html;
        } catch (error) {
            console.error('Error loading gift codes:', error);
            document.getElementById('giftCodesList').innerHTML = '<div style="background:rgba(255,71,87,0.2);color:var(--danger);padding:12px 16px;border-radius:8px;border-left:4px solid var(--danger)">Failed to load gift codes</div>';
        }
    }

    async function loadLikeStats() {
        document.getElementById('likeStats').innerHTML = '<p>Like statistics coming soon. Tracked per IP address.</p>';
    }

    async function loadPurchases() {
        try {
            const response = await fetch('/api/admin/purchases');
            const data = await response.json();

            if (!data.success || !data.purchases || data.purchases.length === 0) {
                document.getElementById('purchasesEmpty').style.display = 'block';
                document.getElementById('purchasesTable').style.display = 'none';
                return;
            }

            document.getElementById('purchasesEmpty').style.display = 'none';
            document.getElementById('purchasesTable').style.display = 'table';

            const tbody = document.getElementById('purchasesTableBody');
            tbody.innerHTML = '';

            data.purchases.forEach(purchase => {
                const statusClass = 'status-' + purchase.status.toLowerCase().replace(/ /g, '-');
                const date = new Date(purchase.created_at).toLocaleDateString();
                
                let actionButtons = '';
                if (purchase.status === 'Awaiting user contact') {
                    actionButtons = `<button class="btn-status-action" onclick="updatePurchaseStatus(${purchase.id}, 'Awaiting transaction')">Mark Transaction</button>`;
                } else if (purchase.status === 'Awaiting transaction') {
                    actionButtons = `<button class="btn-status-action" onclick="showApprovalModal(${purchase.id}, '${purchase.email}', '${purchase.username}', '${purchase.item}')">Approve & Send Key</button>`;
                } else {
                    actionButtons = '<span style="color:var(--success);font-weight:600">âœ“ Completed</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${purchase.username}</td>
                    <td style="font-size:0.9rem">${purchase.email}</td>
                    <td>${purchase.platform}</td>
                    <td>${purchase.item}</td>
                    <td>${purchase.price}</td>
                    <td><span class="status-badge ${statusClass}">${purchase.status}</span></td>
                    <td>${date}</td>
                    <td class="purchase-actions">${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading purchases:', error);
            document.getElementById('purchasesTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--danger)">Error loading purchases</td></tr>';
        }
    }

    async function updatePurchaseStatus(purchaseId, newStatus) {
        try {
            const response = await fetch(`/api/admin/purchase/${purchaseId}/status`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: newStatus})
            });

            if (response.ok) {
                toast(`âœ“ Status updated to: ${newStatus}`);
                loadPurchases();
            } else {
                const data = await response.json();
                toast(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            toast('Error updating status');
        }
    }

    let approvalModal = null;
    async function showApprovalModal(purchaseId, email, username, item) {
        try {
            // Call backend to generate key
            const response = await fetch('/api/keys/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({duration: 365})
            });
            
            const data = await response.json();
            if (!response.ok) {
                alert('Error generating key: ' + (data.error || 'Unknown error'));
                return;
            }
            
            const accessKey = data.key.code;
            approvalModal = {purchaseId, email, username, item, accessKey};
            
            alert(`Purchase ID: ${purchaseId}\nUsername: ${username}\nEmail: ${email}\nItem: ${item}\n\nGenerated Key: ${accessKey}\n\nClick OK to send the key and mark as completed.`);
            approvePurchase(purchaseId, accessKey);
        } catch (error) {
            console.error('Error generating key:', error);
            alert('Error generating key');
        }
    }

    function generateAccessKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    async function approvePurchase(purchaseId, accessKey) {
        try {
            const response = await fetch(`/api/admin/purchase/${purchaseId}/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({access_key: accessKey})
            });

            const data = await response.json();
            if (response.ok) {
                toast('âœ“ Key sent successfully! Purchase marked as completed.');
                loadPurchases();
            } else {
                toast(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error approving purchase:', error);
            toast('Error approving purchase');
        }
    }

    function showShopMessage(elementId, message, type) {
        const el = document.getElementById(elementId);
        const className = type === 'success' ? 'success-msg' : 'error-msg';
        const bgColor = type === 'success' ? 'rgba(46,213,115,0.2)' : 'rgba(255,71,87,0.2)';
        const textColor = type === 'success' ? 'var(--success)' : 'var(--danger)';
        const borderColor = type === 'success' ? 'var(--success)' : 'var(--danger)';
        el.innerHTML = `<div style="background:${bgColor};color:${textColor};padding:12px 16px;border-radius:8px;border-left:4px solid ${borderColor}">${message}</div>`;
        setTimeout(() => el.innerHTML = '', 5000);
    }

    // Initial loads
    fetchUsers();
    fetchPingStatus();
    fetchLogs();
    fetchRecent();
    fetchStats();
    loadDebug();
    fetchTestimonials();
    loadCustomMessage();
    loadBotVersion();
    
    // ============ SEND GIFTS SECTION ============
    
    // Store all available shop items
    let allShopItems = [];
    
    async function loadShopItems() {
        try {
            const response = await fetch('/api/shop/data');
            const shopData = await response.json();
            
            allShopItems = [];
            
            // Add base shop items
            const baseItems = [
                { type: 'GOLDV2_1', name: 'Gold Pack S - 450 Gems', category: 'gems', value: 2.99 },
                { type: 'GOLDV2_2', name: 'Gold Pack M - 3400 Gems', category: 'gems', value: 19.99 },
                { type: 'GOLDV2_3', name: 'Gold Pack L - 9000 Gems', category: 'gems', value: 49.99 },
                { type: 'BATTLE_PASS', name: 'Battle Pass', category: 'premium', value: 3.99 },
                { type: 'BATTLE_PASS_BUNDLE', name: 'Battle Pass Bundle', category: 'premium', value: 7.99 },
                { type: 'LOOT_BOX_1', name: 'Loot Box x3', category: 'lootbox', value: 1.99 },
                { type: 'LOOT_BOX_2', name: 'Loot Box x30', category: 'lootbox', value: 15.99 },
                { type: 'LOOT_BOX_3', name: 'Loot Box x100', category: 'lootbox', value: 44.99 }
            ];
            allShopItems.push(...baseItems);
            
            // Add bundles
            if (shopData.bundles) {
                shopData.bundles.forEach(b => {
                    allShopItems.push({
                        type: b.type,
                        name: b.name || b.type,
                        category: 'bundles',
                        value: b.price || 0
                    });
                });
            }
            
            // Add calendars
            if (shopData.calendars) {
                shopData.calendars.forEach(c => {
                    allShopItems.push({
                        type: c.id,
                        name: c.title || c.iconName,
                        category: 'calendar',
                        value: c.price || 3.99
                    });
                });
            }
            
            // Add skin sets
            if (shopData.skin_sets) {
                shopData.skin_sets.forEach(s => {
                    allShopItems.push({
                        type: s.type,
                        name: s.name,
                        category: 'skinsets',
                        value: s.price || 2.49
                    });
                });
            }
            
            // Add daily skins
            if (shopData.daily_skins) {
                shopData.daily_skins.forEach(d => {
                    allShopItems.push({
                        type: d.imageName,
                        name: d.name,
                        category: 'dailyskins',
                        value: d.price || 2.49
                    });
                });
            }
        } catch (error) {
            console.error('Error loading shop items:', error);
        }
    }
    
    function updateGiftForm() {
        const giftType = document.getElementById('giftType').value;
        let html = '';
        
        if (giftType === 'gems') {
            html = `
                <div class="form-group">
                    <label>Gems Package</label>
                    <select id="giftItem" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff">
                        <option value="">-- Select Package --</option>
                        <option value="GOLDV2_1">ğŸª™ 450 Gems (â‚¬2.99 value)</option>
                        <option value="GOLDV2_2">ğŸª™ 3400 Gems (â‚¬19.99 value)</option>
                        <option value="GOLDV2_3">ğŸª™ 9000 Gems (â‚¬49.99 value)</option>
                    </select>
                </div>
            `;
        } else if (giftType === 'bundle') {
            const bundles = allShopItems.filter(i => i.category === 'bundles');
            let options = '<option value="">-- Select Bundle --</option>';
            bundles.forEach(b => {
                options += `<option value="${b.type}">${b.name} (â‚¬${b.value.toFixed(2)})</option>`;
            });
            html = `
                <div class="form-group">
                    <label>Bundle</label>
                    <select id="giftItem" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff">
                        ${options}
                    </select>
                </div>
            `;
        } else if (giftType === 'calendar') {
            const calendars = allShopItems.filter(i => i.category === 'calendar');
            let options = '<option value="">-- Select Calendar --</option>';
            calendars.forEach(c => {
                options += `<option value="${c.type}">${c.name} (â‚¬${c.value.toFixed(2)})</option>`;
            });
            html = `
                <div class="form-group">
                    <label>Calendar</label>
                    <select id="giftItem" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff">
                        ${options}
                    </select>
                </div>
            `;
        } else if (giftType === 'premium') {
            html = `
                <div class="form-group">
                    <label>Premium Item</label>
                    <select id="giftItem" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:#fff">
                        <option value="BATTLE_PASS">ğŸ‘‘ Battle Pass (â‚¬3.99)</option>
                        <option value="BATTLE_PASS_BUNDLE">ğŸ‘‘ Battle Pass Bundle (â‚¬7.99)</option>
                        <option value="LOOT_BOX_1">ğŸ Loot Box x3 (â‚¬1.99)</option>
                        <option value="LOOT_BOX_2">ğŸ Loot Box x30 (â‚¬15.99)</option>
                        <option value="LOOT_BOX_3">ğŸ Loot Box x100 (â‚¬44.99)</option>
                    </select>
                </div>
            `;
        } else if (giftType === 'custom') {
            html = `
                <div class="form-group">
                    <label>Item Type/ID</label>
                    <input id="giftItem" placeholder="e.g., BATTLE_PASS or calendar-id" />
                </div>
                <div class="form-group">
                    <label>Item Name (for display)</label>
                    <input id="giftItemName" placeholder="What should it be called?" />
                </div>
                <div class="form-group">
                    <label>Estimated Value (â‚¬)</label>
                    <input type="number" id="giftItemValue" placeholder="2.99" step="0.01" />
                </div>
            `;
        }
        
        document.getElementById('giftFormContainer').innerHTML = html;
    }
    
    function quickSelectGift(itemType) {
        document.getElementById('giftType').value = 'gems';
        if (itemType.includes('GOLD')) document.getElementById('giftType').value = 'gems';
        else if (itemType.includes('BUNDLE')) document.getElementById('giftType').value = 'bundle';
        else if (itemType.includes('PASS')) document.getElementById('giftType').value = 'premium';
        else if (itemType.includes('calendar')) document.getElementById('giftType').value = 'calendar';
        
        updateGiftForm();
        document.getElementById('giftItem').value = itemType;
    }
    
    async function sendGift() {
        const username = document.getElementById('giftUsername').value.trim();
        const giftType = document.getElementById('giftType').value;
        const giftItem = document.getElementById('giftItem')?.value.trim();
        const message = document.getElementById('giftMessage').value.trim();
        
        if (!username) {
            alert('âŒ Please enter a recipient username');
            return;
        }
        if (!giftType || !giftItem) {
            alert('âŒ Please select a gift type and item');
            return;
        }
        
        // Find item info
        let itemName = giftItem;
        let itemValue = 0;
        const foundItem = allShopItems.find(i => i.type === giftItem);
        if (foundItem) {
            itemName = foundItem.name;
            itemValue = foundItem.value;
        }
        
        if (giftType === 'custom') {
            itemName = document.getElementById('giftItemName')?.value || giftItem;
            itemValue = parseFloat(document.getElementById('giftItemValue')?.value || 0);
        }
        
        try {
            const response = await fetch('/api/admin/send-gift', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    item: {
                        type: giftItem,
                        name: itemName,
                        price: itemValue
                    },
                    message: message
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`âœ… Gift sent to ${username}!`);
                document.getElementById('giftUsername').value = '';
                document.getElementById('giftType').value = '';
                document.getElementById('giftFormContainer').innerHTML = '';
                document.getElementById('giftMessage').value = '';
                fetchGiftHistory();
            } else {
                alert(`âŒ Error: ${data.error || 'Failed to send gift'}`);
            }
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        }
    }
    
    async function fetchGiftHistory() {
        try {
            const response = await fetch('/api/admin/gift-history');
            const data = await response.json();
            
            const tbody = document.getElementById('giftHistoryTable')?.querySelector('tbody');
            if (!tbody) return;
            
            if (!data.gifts || data.gifts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted)">No gifts sent yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.gifts.map(gift => `
                <tr>
                    <td style="padding:12px">${gift.created_at || gift.date || 'N/A'}</td>
                    <td style="padding:12px"><strong>${gift.username}</strong></td>
                    <td style="padding:12px">${gift.item_name || gift.item}</td>
                    <td style="padding:12px">â‚¬${(gift.item_value || 0).toFixed(2)}</td>
                    <td style="padding:12px"><span style="color:var(--success);font-weight:600">âœ… Sent</span></td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching gift history:', error);
        }
    }
    
    // Load roses/gems purchases
    async function loadRosesGemsPurchases() {
        try {
            const response = await fetch('/api/admin/purchases');
            const data = await response.json();

            if (!data.success || !data.purchases || data.purchases.length === 0) {
                document.getElementById('rosesGemsTable').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted)">No roses/gems purchases</td></tr>';
                document.getElementById('rosesGemsBadge').textContent = '0';
                document.getElementById('pendingRosesGemsBtn').style.display = 'none';
                return;
            }

            const tbody = document.getElementById('rosesGemsTable');
            tbody.innerHTML = '';
            
            let pendingCount = 0;

            data.purchases.forEach(purchase => {
                // Filter only roses and gems
                if (purchase.currency !== 'roses' && purchase.currency !== 'gems') return;
                
                if (purchase.status !== 'Completed') pendingCount++;
                
                const statusClass = 'status-' + purchase.status.toLowerCase().replace(/ /g, '-');
                const date = new Date(purchase.created_at).toLocaleDateString();
                
                let actionButtons = '';
                if (purchase.status === 'Awaiting user contact') {
                    actionButtons = `<button class="btn-status-action" onclick="updatePurchaseStatus(${purchase.id}, 'Awaiting transaction')">Mark Transaction</button>`;
                } else if (purchase.status === 'Awaiting transaction') {
                    actionButtons = `<button class="btn-status-action" onclick="showApprovalModal(${purchase.id}, '${purchase.email}', '${purchase.username}', '${purchase.item}')">Approve & Send Key</button>`;
                } else {
                    actionButtons = '<span style="color:var(--success);font-weight:600">âœ“ Completed</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding:12px">${purchase.username}</td>
                    <td style="padding:12px;font-size:0.9rem">${purchase.email}</td>
                    <td style="padding:12px">${purchase.item}</td>
                    <td style="padding:12px;text-transform:capitalize">${purchase.currency}</td>
                    <td style="padding:12px">${purchase.price}</td>
                    <td style="padding:12px;text-transform:capitalize">${purchase.platform}</td>
                    <td style="padding:12px"><span class="status-badge ${statusClass}">${purchase.status}</span></td>
                    <td style="padding:12px">${date}</td>
                    <td style="padding:12px;text-align:center" class="purchase-actions">${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });

            // Update badge
            document.getElementById('rosesGemsBadge').textContent = pendingCount;
            document.getElementById('pendingRosesGemsBtn').style.display = pendingCount > 0 ? 'inline-block' : 'none';
        } catch (error) {
            console.error('Error loading roses/gems purchases:', error);
            document.getElementById('rosesGemsTable').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--danger)">Error loading purchases</td></tr>';
        }
    }

    // Load PayPal purchases
    async function loadPayPalPurchases() {
        try {
            const response = await fetch('/api/admin/paypal-purchases', {
                method: 'GET',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });

            const data = await response.json();
            
            if (!response.ok || !data.success) {
                document.getElementById('paypalTable').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">No PayPal purchases</td></tr>';
                return;
            }

            const tbody = document.getElementById('paypalTable');
            tbody.innerHTML = '';

            if (!data.purchases || data.purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">No PayPal purchases yet</td></tr>';
                return;
            }

            data.purchases.forEach(purchase => {
                const date = new Date(purchase.created_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusClass = purchase.status === 'Completed' ? 'status-completed' : 'status-pending';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding:12px">${purchase.username}</td>
                    <td style="padding:12px;font-size:0.9rem">${purchase.email}</td>
                    <td style="padding:12px">${purchase.item}</td>
                    <td style="padding:12px;font-weight:600">$${parseFloat(purchase.price).toFixed(2)}</td>
                    <td style="padding:12px">${purchase.currency}</td>
                    <td style="padding:12px"><span class="status-badge ${statusClass}">${purchase.status}</span></td>
                    <td style="padding:12px;font-size:0.9rem">${date}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading PayPal purchases:', error);
            document.getElementById('paypalTable').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--danger)">Error loading purchases</td></tr>';
        }
    }
    
    // Load shop items on page load
    loadShopItems();
    fetchGiftHistory();
  </script>
</body>
</html>